/*!
 * SharepointPlus v5.0
 * Copyright 2017, Aymeric (@aymkdn)
 * Contact: http://kodono.info
 * Documentation: http://aymkdn.github.com/SharepointPlus/
 * License: LGPL-3 (http://aymkdn.github.com/SharepointPlus/license.md)
 */
var SPArrayChunk=function(e,t){for(var r=[],i=0,o=e.length;o>i;i+=t)r.push(e.slice(i,i+t));return r},SPExtend=function(){var e,t,r,i,o=arguments[0]||{},n=1,a=arguments.length,s=!1,l=function(e){if(null===e||"object"!=typeof e||e.nodeType||null!==e&&e===e.window)return!1;try{if(e.constructor&&!this.hasOwnProperty.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch(t){return!1}return!0};for("boolean"==typeof o&&(s=o,o=arguments[n]||{},n++),"object"!=typeof o&&"function"!=typeof o&&(o={}),!1;a>n;n+=1)if(null!==(e=arguments[n]))for(t in e)o!==e[t]&&"undefined"==typeof o[t]&&(s&&e[t]&&(l(e[t])||(r=Array.isArray(e[t])))?(r?(r=!1,i=o[t]&&Array.isArray(o[t])?o[t]:[]):i=o[t]&&l(o[t])?o[t]:{},o[t]=SPExtend(s,i,e[t])):void 0!==e[t]&&(o[t]=e[t]));return o},SPArrayBufferToBase64=function(e){for(var t,r,i,o,n,a="",s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",l=new Uint8Array(e),u=l.byteLength,c=u%3,d=u-c,f=0;d>f;f+=3)n=l[f]<<16|l[f+1]<<8|l[f+2],t=(16515072&n)>>18,r=(258048&n)>>12,i=(4032&n)>>6,o=63&n,a+=s[t]+s[r]+s[i]+s[o];return 1==c?(n=l[d],t=(252&n)>>2,r=(3&n)<<4,a+=s[t]+s[r]+"=="):2==c&&(n=l[d]<<8|l[d+1],t=(64512&n)>>10,r=(1008&n)>>4,i=(15&n)<<2,a+=s[t]+s[r]+s[i]+"="),a},_SP_CACHE_CONTENTTYPES=[],_SP_CACHE_CONTENTTYPE=[],_SP_CACHE_SAVEDVIEW=[],_SP_CACHE_SAVEDVIEWS=[],_SP_CACHE_SAVEDLISTS=[],_SP_CACHE_USERGROUPS=[],_SP_CACHE_GROUPMEMBERS=[],_SP_CACHE_DISTRIBUTIONLISTS=[],_SP_CACHE_REGIONALSETTINGS=void 0,_SP_CACHE_DATEFORMAT=void 0,_SP_CACHE_HASREST={},_SP_CACHE_REQUESTDIGEST={},_SP_ADD_PROGRESSVAR={},_SP_UPDATE_PROGRESSVAR={},_SP_MODERATE_PROGRESSVAR={},_SP_REMOVE_PROGRESSVAR={},_SP_BASEURL=void 0,_SP_NOTIFY_READY=!1,_SP_NOTIFY_QUEUE=[],_SP_NOTIFY=[],_SP_PLUGINS={},_SP_MODALDIALOG_LOADED=!1,_SP_MAXWHERE_ONLOOKUP=30,_SP_ISBROWSER=new Function("try {return this===window;}catch(e){ return false;}")(),_SP_JSON_ACCEPT="verbose";!function(e,t,r){function i(){return this instanceof arguments.callee?void 0:new arguments.callee}var o=function(e,t){for(var r=e.length,i=new Array(r),o=r/8,n=r%8,a=r-1;a>-1;a--){var s=o,l=n;do{switch(l){case 0:i[a]=t(e[a]),a--;case 7:i[a]=t(e[a]),a--;case 6:i[a]=t(e[a]),a--;case 5:i[a]=t(e[a]),a--;case 4:i[a]=t(e[a]),a--;case 3:i[a]=t(e[a]),a--;case 2:i[a]=t(e[a]),a--;case 1:i[a]=t(e[a]),a--}l=0}while(--s>0)}return i};i.prototype={data:[],length:0,listQueue:[],needQueue:!1,module_sprequest:null,credentialOptions:null,proxyweb:null,getVersion:function(){return"5.0"},_promise:function(e){return new Promise(e)},hasREST:function(t){var r=this;return r._promise(function(i){t=t||{};var o=(t.url||r.url||e.location.href).split("/").slice(0,3).join("/");if("boolean"==typeof _SP_CACHE_HASREST[o])return void i(_SP_CACHE_HASREST[o]);var n,a=!(!t.url&&_SP_ISBROWSER&&"undefined"!=typeof SP);if(!a){if("undefined"!=typeof SP&&SP.ClientSchemaVersions)return n=parseInt(SP.ClientSchemaVersions.currentVersion)>14,_SP_CACHE_HASREST[o]=n,void i(n);a=!0}a?r.ajax({url:o+"/_api/web/Url"}).then(function(){_SP_CACHE_HASREST[o]=!0,i(!0)},function(){_SP_CACHE_HASREST[o]=!1,i(!1)}):(_SP_CACHE_HASREST[o]=!1,i(!1))})},getRequestDigest:function(r){var i=this;return i._promise(function(o,n){r=r||{},r.cache=r.cache!==!1;var a,s,l=(r.url||i.url||e.location.href).split("/").slice(0,3).join("/");return r.cache&&(s=_SP_CACHE_REQUESTDIGEST[l]),s&&(new Date).getTime()-new Date(s.split(",")[1]).getTime()<864e5?void o(s):_SP_ISBROWSER&&t&&r.cache&&(a=t.querySelector("#__REQUESTDIGEST"))?(s=a.value,_SP_CACHE_REQUESTDIGEST[l]=s,void o(s)):void i.ajax({url:l+"/_api/contextinfo",method:"POST"}).then(function(e){s=e.d.GetContextWebInformation.FormDigestValue,_SP_CACHE_REQUESTDIGEST[l]=s,t&&(a=t.querySelector("#__REQUESTDIGEST"),a&&(a.value=s)),o(s)},function(e){n(e)})})},ajax:function(e){var t=this;return e.headers=e.headers||{},!function(e,t){function r(e){return e&&t.XDomainRequest&&!/MSIE 1/.test(navigator.userAgent)?new XDomainRequest:t.XMLHttpRequest?new XMLHttpRequest:void 0}function i(e,t,r){e[t]=e[t]||r}var o=["responseType","withCredentials","timeout"];e.ajax=function(e,n){function a(e,t){return function(){c||(n(void 0===d.status?e:d.status,0===d.status?"Error":d.response||d.responseText||t,d),c=!0)}}var s=e.headers||{},l=e.body,u=e.method||(l?"POST":"GET"),c=!1,d=r(e.cors);d.open(u,e.url,!0);var f=d.onload=a(200);d.onreadystatechange=function(){4===d.readyState&&f()},d.onerror=a(null,"Error"),d.ontimeout=a(null,"Timeout"),d.onabort=a(null,"Abort"),l&&(t.FormData&&l instanceof t.FormData||i(s,"Content-Type","application/x-www-form-urlencoded"));for(var h,p=0,g=o.length;g>p;p++)h=o[p],void 0!==e[h]&&(d[h]=e[h]);for(var h in s)s[h]!==!1&&d.setRequestHeader(h,s[h]);return e.onprogress&&d.upload.addEventListener("progress",e.onprogress,!1),e.getXHR&&e.getXHR(d),d.send(l),d},t.nanoajax=e}({},function(){return this}()),t._promise(function(r,i){var o=!1;if(e.url.toLowerCase().indexOf("/_api/")>-1&&-1===e.url.toLowerCase().indexOf("_api/web/url")&&("undefined"==typeof e.headers.Accept&&(e.headers.Accept="application/json;odata="+_SP_JSON_ACCEPT),"undefined"==typeof e.headers["Content-Type"]&&(e.headers["Content-Type"]="application/json;odata="+_SP_JSON_ACCEPT),"undefined"==typeof e.headers["X-RequestDigest"]&&-1===e.url.indexOf("contextinfo")&&(o=!0)),e.url.toLowerCase().indexOf("_vti_bin/client.svc/processquery")>-1&&"undefined"==typeof e.headers["X-RequestDigest"]&&(o=!0),o)return void t.getRequestDigest().then(function(r){return e.headers["X-RequestDigest"]=r,t.ajax(e)}).then(function(e){r(e)})["catch"](function(e){i(e)});if("undefined"==typeof e.headers["Content-Type"]&&(e.headers["Content-Type"]="text/xml; charset=utf-8"),_SP_ISBROWSER)"POST"!==e.method||e.body||(e.body=""),nanoajax.ajax(e,function(o,n,a){if(o>=200&&300>o&&"Error"!==n&&"Abort"!==n&&"Timeout"!==n){var s=a.responseType&&"document"!==a.responseType?n:a.responseXML||a.responseText;a.getResponseHeader("Content-Type").indexOf("/json")>-1&&"string"==typeof s&&(s=JSON.parse(s)),r(s)}else 403==o&&n.indexOf("The security validation for this page is invalid and might be corrupted. Please use your web browser's Back button to try your operation again.")>-1?(delete e.headers["X-RequestDigest"],t.getRequestDigest({cache:!1}).then(function(r){return e.headers["X-RequestDigest"]=r,t.ajax(e)}).then(function(e){r(e)})["catch"](function(e){i(e)})):i({statusCode:o,responseText:n,request:a})});else{if(null===t.module_sprequest){if(null===t.credentialOptions)throw"[SharepointPlus 'ajax'] please use `$SP().auth()` to provide your credentials first";t.module_sprequest=require("sp-request").create(t.credentialOptions)}e.headers["Content-Type"].indexOf("xml")>-1&&(e.headers.Accept="application/xml, text/xml, */*; q=0.01"),e.method&&"POST"!==e.method.toUpperCase()||(e.headers["Content-Length"]=Buffer.byteLength(e.body)),e.headers["User-Agent"]="Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:52.0) Gecko/20100101 Firefox/52.0";var n={json:!1,method:e.method||(e.body?"POST":"GET"),strictSSL:!1,headers:e.headers,jar:!0};e.body&&(n.body=e.body),t.proxyweb&&(n.proxy=t.proxyweb),n.headers&&delete n.headers["Content-Length"],t.module_sprequest(e.url,n).then(function(e){if(200===e.statusCode&&"Error"!==e.statusMessage&&"Abort"!==e.statusMessage&&"Timeout"!==e.statusMessage)if(e.headers["content-type"].indexOf("xml")>-1&&"<?xml"===e.body.slice(0,5)){var t=require("xmldom").DOMParser,o=(new t).parseFromString(e.body);r(o)}else e.headers["content-type"].indexOf("json")>-1&&"string"==typeof e.body&&(e.body=JSON.parse(e.body)),r(e.body);else i({response:e,statusCode:e.statusCode,responseText:e.body})},function(e){i({statusCode:e.statusCode,response:e.response,responseText:e.response?e.response.body:""})})}})},auth:function(e){return this.credentialOptions=e,this},proxy:function(e){return this.proxyweb=e,this},list:function(e,t){var r=this.reset();return t?r.url="/"===t.slice(-1)?t.slice(0,-1):t:r._getURL(),r.listID=e.replace(/&/g,"&amp;"),r},_getURL:function(t){var r=this;return t=t!==!1,r._promise(function(i,o){if("undefined"==typeof r.url)if("undefined"!=typeof _SP_BASEURL)t&&(r.url=_SP_BASEURL),i(_SP_BASEURL);else if("undefined"!=typeof L_Menu_BaseUrl)t&&(r.url=_SP_BASEURL=L_Menu_BaseUrl),i(L_Menu_BaseUrl);else{if("undefined"==typeof _spPageContextInfo||"undefined"==typeof _spPageContextInfo.webServerRelativeUrl)return r.needQueue=!0,void r.ajax({url:"/_vti_bin/Webs.asmx",body:r._buildBodyForSOAP("WebUrlFromPageUrl","<pageUrl>"+e.location.href.replace(/&/g,"&amp;")+"</pageUrl>")}).then(function(e){var n=e.getElementsByTagName("WebUrlFromPageUrlResult");if(n.length){var a=n[0].firstChild.nodeValue.toLowerCase();t&&(r.url=_SP_BASEURL=a),i(a)}else o("[SharepointPlus '_getURL'] Unable to retrieve the URL");r.needQueue=!1},function(e){o(e)});t&&(r.url=_SP_BASEURL=_spPageContextInfo.webServerRelativeUrl),i(_spPageContextInfo.webServerRelativeUrl)}o("[SharepointPlus '_getURL'] Unable to retrieve the URL")})},getURL:function(){return this._getURL(!1)},_buildBodyForSOAP:function(e,t,r){return r=r||"http://schemas.microsoft.com/sharepoint/soap/",'<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"><soap:Body><'+e+' xmlns="'+r+'">'+t+"</"+e+"></soap:Body></soap:Envelope>"},webService:function(e){var t=this;return t._promise(function(r,i){var o,n,a="";if(!e.service)throw"Error 'webService': the option 'service' is required";if(!e.operation)throw"Error 'webService': the option 'operation' is required";if(e.webURL=e.webURL||t.url,!e.webURL)return void t._getURL().then(function(o){e.webURL=o,t.webService(e).then(function(e){r(e)},function(e){i(e)})},function(e){i(e)});e.properties=e.properties||{};for(o in e.properties)e.properties.hasOwnProperty(o)&&(a+="<"+o+">"+e.properties[o]+"</"+o+">");e.soapAction=e.soapAction!==!1,e.soapURL=e.soapURL||"http://schemas.microsoft.com/sharepoint/soap/",e.soapAction||(e.soapURL=e.soapURL.replace(/\/$/,"")),a=t._buildBodyForSOAP(e.operation,a,e.soapURL),n={url:e.webURL+"/_vti_bin/"+e.service+".asmx",body:a},e.soapAction&&(n.headers={SOAPAction:e.soapURL+e.operation}),t.ajax(n).then(function(e){r(e)},function(e){i(e)})})},_addInQueue:function(e){var t=this;return t.listQueue.push(e),1===t.listQueue.length&&t._testQueue(),t},_testQueue:function(){var e=this;if(e.needQueue)setTimeout(function(){e._testQueue.call(e)},25);else{if(e.listQueue.length>0){var t=e.listQueue.shift();t.callee.apply(e,Array.prototype.slice.call(t))}e.needQueue=e.listQueue.length>0,e.needQueue&&setTimeout(function(){e._testQueue.call(e)},25)}},parse:function(e,t){var r=e.replace(/(\s+)?(=|~=|<=|>=|<>|<|>| LIKE | IN )(\s+)?/g,"$2").replace(/""|''/g,"Null").replace(/==/g,"="),i=[];t=t!==!1;for(var o=e.length,n="",a="",s=!1,l="",u={open:0},c=!1,d=0;d<r.length;d++){var f=r.charAt(d);switch(f){case"(":for(var h=d,p=!1;"("==r.charAt(d)&&o>d;)d++,u.open++;for(;u.open>0&&o>d;){d++;var g=r.charAt(d);"\\"==g?s=!0:s||"'"!=g&&'"'!=g?s||")"!=g||p?s=!1:u.open--:p=!p}var m=i.length-1;m>=0?(""!=n&&(i[0]="<"+n+">"+i[0]),i[0]+=this.parse(r.substring(h+1,d)),""!=n&&(i[0]+="</"+n+">"),n=""):i[0]=this.parse(r.substring(h+1,d));break;case"[":for(var h=d,p=!1;o>d;){d++;var g=r.charAt(d);if("\\"==g)s=!0;else if(s||"'"!=g&&'"'!=g){if(!s&&!p&&"]"==g)break;s=!1}else p=!p}var m=i.length-1,S=JSON.parse("["+r.substring(h+1,d)+"]"),_="Text";switch(typeof S[0]){case"number":_="Number";break;default:"~"===S[0].charAt(0)&&"number"==typeof(1*S[0].slice(1))&&(_="Integer",S.forEach(function(e,t){S[t]=e.slice(1)}))}i[m]+='<FieldRef Name="'+l+'" '+("Integer"===_?'LookupId="True"':"")+' /><Values><Value Type="'+_+'">'+S.join('</Value><Value Type="'+_+'">')+"</Value></Values>"+a,l="",a="",m>0&&(""!=n&&(i[0]="<"+n+">"+i[0]),i[0]+=i[m],""!=n&&(i[0]+="</"+n+">"),delete i[m],n="");break;case">":case"<":d++,"="==r.charAt(d)?(i.push("<"+(">"==f?"G":"L")+"eq>"),a="</"+(">"==f?"G":"L")+"eq>"):"<"==f&&">"==r.charAt(d)?(i.push("<Neq>"),a="</Neq>"):(d--,i.push("<"+(">"==f?"G":"L")+"t>"),a="</"+(">"==f?"G":"L")+"t>");break;case"~":"="==r.charAt(d+1)&&(c=!0);break;case"=":i.push("<Eq>"),a="</Eq>";break;case" ":" AND "==r.substring(d,d+5).toUpperCase()?(n="And",d+=4):" OR "==r.substring(d,d+4).toUpperCase()?(n="Or",d+=3):" LIKE "==r.slice(d,d+6).toUpperCase()?(d+=5,i.push("<Contains>"),a="</Contains>"):" IN "==r.slice(d,d+4).toUpperCase()?(d+=3,i.push("<In>"),a="</In>"):l+=f;break;case'"':case"'":for(var y=f,A="",w="";(f=r.charAt(++d))!=y&&o>d;)"\\"==f&&(f=r.charAt(++d)),A+=f;m=i.length-1,i[m]+='<FieldRef Name="'+l+'" '+("[Me]"==A?'LookupId="True" ':"")+"/>",l="";var v="Text";/\d{4}-\d\d?-\d\d?((T| )\d{2}:\d{2}:\d{2})?/.test(A)&&(v="DateTime",/\d{4}-\d\d?-\d\d?((T| )\d{2}:\d{2}:\d{2})/.test(A)&&(w=' IncludeTimeValue="TRUE"')),t&&(A=this._cleanString(A)),"[Me]"===A?(A='<UserID Type="Integer" />',v="Integer"):"[Today"==A.slice(0,6)&&(v="DateTime",A='<Today OffsetDays="'+1*A.slice(6,-1)+'" />'),i[m]+='<Value Type="'+v+'"'+w+">"+A+"</Value>",i[m]+=a,a="",m>0&&(""!=n&&(i[0]="<"+n+">"+i[0]),i[0]+=i[m],""!=n&&(i[0]+="</"+n+">"),delete i[m],n="");break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":if(""!=a){for(var I=f;!isNaN(f=r.charAt(++d))&&o>d;)I+=""+f;m=i.length-1,i[m]+='<FieldRef Name="'+l+'"'+(c?' LookupId="True"':"")+" />",l="",i[m]+='<Value Type="'+(c?"Integer":"Number")+'">'+I.replace(/ $/,"")+"</Value>",i[m]+=a,a="",m>0&&(""!=n&&(i[0]="<"+n+">"+i[0]),i[0]+=i[m],""!=n&&(i[0]+="</"+n+">"),delete i[m],n=""),d-=2;break}default:""==a?l+=f:"n"==f.toLowerCase()&&"null"==r.substring(d,d+4).toLowerCase()?(m=i.length-1,"</Neq>"==a?(i[m]="<IsNotNull>",a="</IsNotNull>"):"</Eq>"==a&&(i[m]="<IsNull>",a="</IsNull>"),d+=3,i[m]+='<FieldRef Name="'+l+'" />',l="",i[m]+=a,a="",m>0&&(""!=n&&(i[0]="<"+n+">"+i[0]),i[0]+=i[m],""!=n&&(i[0]+="</"+n+">"),delete i[m],n="")):("t"===f.toLowerCase()&&"true"===r.substring(d,d+4).toLowerCase()||"f"===f.toLowerCase()&&"false"===r.substring(d,d+5).toLowerCase())&&(m=i.length-1,d+=3,"f"===f.toLowerCase()&&d++,i[m]+='<FieldRef Name="'+l+'" /><Value Type="Boolean">'+("t"===f.toLowerCase()?1:0)+"</Value>",l="",i[m]+=a,a="",m>0&&(""!=n&&(i[0]="<"+n+">"+i[0]),i[0]+=i[m],""!=n&&(i[0]+="</"+n+">"),delete i[m],n=""))}}return i.join("")},_parseOn:function(e){for(var t,r=[],i=0,o=e.replace(/(\s+)?(=)(\s+)?/g,"$2").replace(/==/g,"=").split(" AND ");i<o.length;i++)if(t=o[i].match(/'([^']+)'\.([a-zA-Z0-9_]+)='([^']+)'\.([a-zA-Z0-9_]+)/),t&&5==t.length){var n={};n[t[1]]=t[2],n[t[3]]=t[4],r.push(n)}return r},_cleanString:function(e){return e.replace(/&(?!amp;|lt;|gt;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},cleanResult:function(e,t){return null===e||"undefined"==typeof e?"":(t=t||";","string"==typeof e?e.replace(/^(string;|float;|datetime;)#?/,"").replace(/;#[0-9]+;#/g,t).replace(/^[0-9]+;#/,"").replace(/^;#|;#$/g,"").replace(/;#/g,t):e)},get:function(e){var t=this;return t._promise(function(i,s){if(t.needQueue)return t._addInQueue(arguments);if(!t.listID)throw"[SharepointPlus 'get']: the list ID/Name is required";var l={};if(SPExtend(!0,l,e),!t.url)throw"[SharepointPlus 'get']: not able to find the URL!";if(l.fields=l.fields||"",l.where=l.where||"",l.whereFct=l.whereFct||function(e){return e},l.orderby=l.orderby||"",l.useIndexForOrderBy=l.useIndexForOrderBy===!0,l.groupby=l.groupby||"",l.rowlimit=l.rowlimit||0,l.whereEscapeChar=l.whereEscapeChar!==!1,l.paging=l.paging===!0,l.page=l.paging===!1||isNaN(l.page)?5e3:l.page,l.paging&&0===l.rowlimit&&(l.rowlimit=5e3),l.expandUserField=l.expandUserField===!0||"True"===l.expandUserField?"True":"False",l.dateInUTC=l.dateInUTC===!0?"True":"False",l.folderOptions=l.folderOptions||null,l.view=l.view||"",l.calendar=l.calendar===!0,l.calendar===!0&&(l.calendarOptions=l.calendarOptions||{},l.calendarOptions.referenceDate=l.calendarOptions.referenceDate||new Date,"string"!=typeof l.calendarOptions.referenceDate&&(l.calendarOptions.referenceDate=t.toSPDate(l.calendarOptions.referenceDate)),l.calendarOptions.splitRecurrence=l.calendarOptions.splitRecurrence===!1?"FALSE":"TRUE",l.calendarOptions.range=l.calendarOptions.range||"Month"),l.results=l.results||[],l.listItemCollectionPositionNext=l.listItemCollectionPositionNext||"",l.listItemCollectionPositionNext&&(l.listItemCollectionPositionNext=l.listItemCollectionPositionNext.replace(/&/g,"&amp;").replace(/&amp;amp;/g,"&amp;")),Array.isArray(l.where)?(l.where=l.where.slice(0),l.originalWhere||(l.originalWhere=l.where.slice(0)),l.nextWhere=l.where.slice(1),l.where=l.where.shift()):(l.originalWhere=l.where,l.nextWhere=[]),l.progress=l.progress||function(){},""!==l.view)return void t.view(l.view).then(function(e){l.view=e.ID;var r=l.whereCAML?l.where:t.parse(l.where),o=e.WhereCAML.match(/^<And>(<DateRangesOverlap>.*<\/DateRangesOverlap>)(.*)<\/And>$/);o&&3===o.length&&(e.WhereCAML="<And>"+o[2]+o[1]+"</And>"),r+=e.WhereCAML,""!==l.where&&""!==e.WhereCAML&&(r="<And>"+r+"</And>"),l.where=r,l.fields+=(""===l.fields?"":",")+e.Fields.join(","),l.orderby+=(""===l.orderby?"":",")+e.OrderBy,l.whereCAML=!0,l.useOWS=!0,l.calendarViaView=l.calendar,l.calendar=!1,delete l.view,t.get(l).then(function(e){i(e)},function(e){s(e)})});var u,c,d,f,h,p,g,m,S="",_="",y="",A="",w="";if(l.fields.length>0)for("string"==typeof l.fields&&(l.fields=l.fields.replace(/^\s+/,"").replace(/\s+$/,"").replace(/( )?,( )?/g,",").split(",")),u=0;u<l.fields.length;u++)S+='<FieldRef Name="'+l.fields[u]+'" />';if(""!==l.orderby)for(c=l.orderby.split(","),u=0;u<c.length;u++)d="ASC",f=c[u].trim().split(" "),f.length>0&&(2==f.length&&(d=f[1].toUpperCase()),_+='<FieldRef Name="'+f[0]+'" Ascending="'+("ASC"==d)+'" />');if(l.calendar!==!0&&l.calendarViaView!==!0||""!==_||(_='<FieldRef Name="EventDate" Ascending="ASC" />'),""!==l.groupby)for(h=l.groupby.split(","),u=0;u<h.length;u++)y+='<FieldRef Name="'+h[u]+'" />';if(l.calendar===!0||l.calendarViaView===!0)for(p=["Title","EventDate","EndDate","Duration","fAllDayEvent","fRecurrence","RecurrenceData","ID"],u=0;u<p.length;u++)S+='<FieldRef Name="'+p[u]+'" />';if(l.queryOptions===r)if(l._queryOptions="<DateInUtc>"+l.dateInUTC+'</DateInUtc><Paging ListItemCollectionPositionNext="'+l.listItemCollectionPositionNext+'"></Paging><IncludeAttachmentUrls>True</IncludeAttachmentUrls>'+(""===S?"":"<IncludeMandatoryColumns>False</IncludeMandatoryColumns>")+"<ExpandUserField>"+l.expandUserField+"</ExpandUserField>",l.folderOptions){switch(l.folderOptions.show){case"FilesAndFolders_Recursive":g="RecursiveAll";break;case"FilesOnly_InFolder":g="FilesOnly";break;case"FilesAndFolders_InFolder":g="";break;case"FilesOnly_Recursive":default:g="Recursive"}l._queryOptions+='<ViewAttributes Scope="'+g+'"></ViewAttributes>',l.folderOptions.path&&(l._queryOptions+="<Folder>"+t.url+"/"+t.listID+"/"+l.folderOptions.path+"</Folder>")}else l._queryOptions+='<ViewAttributes Scope="Recursive"></ViewAttributes>';else l._queryOptions=l.queryOptions;l.calendarOptions&&(l._queryOptions+="<CalendarDate>"+l.calendarOptions.referenceDate+"</CalendarDate><RecurrencePatternXMLVersion>v3</RecurrencePatternXMLVersion><ExpandRecurrence>"+l.calendarOptions.splitRecurrence+"</ExpandRecurrence>"),""!==l.where&&(w=l.whereCAML?l.where:t.parse(l.where)),l.calendar===!0&&(m="<DateRangesOverlap><FieldRef Name='EventDate' /><FieldRef Name='EndDate' /><FieldRef Name='RecurrenceID' /><Value Type='DateTime'><"+l.calendarOptions.range+" /></Value></DateRangesOverlap>",w=""!==w?"<And>"+w+m+"</And>":m),w=l.whereFct(w),A="<listName>"+t.listID+"</listName><viewName>"+(l.viewID||"")+"</viewName><query><Query>"+(""!=w?"<Where>"+w+"</Where>":"")+(""!=y?"<GroupBy>"+y+"</GroupBy>":"")+(""!=_?"<OrderBy"+(l.useIndexForOrderBy?" UseIndexForOrderBy='TRUE' Override='TRUE'":"")+">"+_+"</OrderBy>":"")+"</Query></query><viewFields><ViewFields Properties='True'>"+S+"</ViewFields></viewFields><rowLimit>"+l.rowlimit+"</rowLimit><queryOptions><QueryOptions>"+l._queryOptions+"</QueryOptions></queryOptions>",A=t._buildBodyForSOAP("GetListItems",A),t.ajax({url:t.url+"/_vti_bin/Lists.asmx",body:A}).then(function(e){var u,c,d,f,h,p,g,m,S,_,y,A,w,v,I,P,D,E,b,T,C,N,O,R,x;if(u=e.getElementsByTagName("z:row"),0===u.length&&(u=e.getElementsByTagName("row")),x=o(u,function(e){return n(e)}),l.results.length>0)for(c=0,f=x.length;f>c;c++)l.results.push(x[c]);if("string"!=typeof l.originalWhere&&l.progress(l.originalWhere.length-l.nextWhere.length,l.originalWhere.length),l.paging&&(h=e.getElementsByTagName("rs:data")[0],"undefined"!=typeof h&&0!=h.length||(h=e.getElementsByTagName("data")[0]),h&&(y=h.getAttribute("ListItemCollectionPositionNext"))),l.paging&&--l.page>0){if(0===l.results.length&&(l.results=x),l.progress(l.results.length),y)return l.listItemCollectionPositionNext=t._cleanString(y),void t.get(l).then(function(e){i(e)},function(e){s(e)});x=l.results}else{if(l.nextWhere.length>0)return 0===l.results.length&&(l.results=x),l.where=l.nextWhere.slice(0),void t.get(l).then(function(e){i(e)},function(e){s(e)});l.where=l.originalWhere,x=l.results.length>0?l.results:x}if(l.joinData){for(p=l.joinData.noindex,g=[],m="",_={length:0},p.length||alert("$SP.get() -- Error 'get': you must define the ON clause when JOIN is used."),c=0,f=x.length;f>c;c++){for(S="",d=0;d<p.length;d++)S+="_"+t.getLookup(x[c].getAttribute(p[d][t.listID])).id;if(l.joinData[S])for(m!==S&&(_[l.joinIndex[S]]||_.length++,_[l.joinIndex[S]]=!0,m=S),d=0,A=l.joinData[S].length;A>d;d++){for(w=[],I=x[c].getAttributes(),P=I.length;P--;)w[t.listID+"."+I[P].nodeName.slice(4)]=I[P].nodeValue;D=l.joinData[S][d].getAttributes();for(P in D)w[P]=l.joinData[S][d].getAttribute(P);g.push(new a(w))}l.innerjoin&&(l.join=l.innerjoin),l.outerjoin&&(l.join=l.outerjoin,l.join.outer=!0)}if(x=g,l.where&&l.where!==l.onLookupWhere&&l.outer&&(l.outer=!1),l.outer&&(E=l.joinIndex.length,_.length<E))for(c=0;E>c;c++)if(_[c]!==!0){if(b=l.joinIndex[c],b===r||l.joinData[b]===r)continue;for(d=0,A=l.joinData[b].length;A>d;d++){w=[],D=l.joinData[b][d].getAttributes();for(P in D)w[P]=l.joinData[b][d].getAttribute(P);g.push(new a(w))}}}if(l.outerjoin?(l.join=l.outerjoin,l.join.outer=!0):l.innerjoin&&(l.join=l.innerjoin),l.join){for(C=[],N=[],O=[],l.join.onLookup&&(l.join.on="'"+l.join.list+"'."+l.join.onLookup+" = '"+t.listID+"'.ID"),p=t._parseOn(l.join.on),C.noindex=p,c=0,f=x.length;f>c;c++){for(S="",w=[],d=0;d<p.length;d++)S+="_"+t.getLookup(x[c].getAttribute(p[d][t.listID])||x[c].getAttribute(t.listID+"."+p[d][t.listID])).id;if(C[S]||(N[S]=N.length,N.push(S),C[S]=[],l.join.onLookup&&"_"!==S&&O.push("~"+S.slice(1))),l.joinData)C[S].push(x[c]);else{for(v=x[c].getAttributes(),d=v.length;d--;)w[t.listID+"."+v[d].nodeName.slice(4)]=v[d].nodeValue;C[S].push(new a(w))}}if(delete l.joinData,l.join.onLookup){if(O.length>0){for(R=SPArrayChunk(O,60),d=0;d<R.length;d++)R[d]=l.join.onLookup+' IN ["'+R[d].join('","')+'"]';R.length<=_SP_MAXWHERE_ONLOOKUP?(R="("+R.join(" OR ")+")",l.join.where?Array.isArray(l.join.where)?l.join.where.forEach(function(e,t){l.join.where[t]=R+" AND ("+e+")"}):l.join.where=R+" AND ("+l.join.where+")":l.join.where=R,l.join.onLookupWhere=R):l.join.paging=!0}l.join.fields||(l.join.fields=[]),Array.isArray(l.join.fields)?l.join.fields.push(l.join.onLookup):(w=l.join.fields.split(","),w.push(l.join.onLookup),l.join.fields=w.join(","))}return T=t.list(l.join.list,l.join.url||t.url),l.join.joinData=C,l.join.joinIndex=N,void T.get(l.join).then(function(e){i(e)},function(e){s(e)})}x.NextPage=y,i(x)},function(e){s(e)})})},createFile:function(t){var i=this;return i._promise(function(o,n){if(i.needQueue)return i._addInQueue(arguments);if(t=t||{},t.content===r)throw"[SharepointPlus 'createFile']: the file content is required.";if(t.filename===r)throw"[SharepointPlus 'createFile']: the filename is required.";if(!i.listID)throw"[SharepointPlus 'createFile']: the library name is required.";if(!i.url)throw"[SharepointPlus 'createFile']: not able to find the URL!";t.extendedFields=t.extendedFields||"",t.progress=t.progress||function(){},t.getXHR=t.getXHR||function(){},i.hasREST().then(function(r){if(r){var a={};i.info().then(function(e){var r=e._List.RootFolder,o=t.filename.split("/"),n=t.filename;return o.length>1?(n=o.slice(-1),o="/"+o.slice(0,-1).join("/")):o="",o=r+o,t.content=new Blob([t.content]),i.ajax({url:i.url+"/_api/web/GetFolderByServerRelativeUrl('"+encodeURIComponent(o)+"')/files/add(url='"+encodeURIComponent(n)+"',overwrite=true)",body:t.content,onprogress:function(e){e.lengthComputable&&t.progress(parseInt(e.loaded/e.total*100))},getXHR:t.getXHR})}).then(function(e){return SPExtend(!0,a,e.d),a.Url=a.__metadata.uri.split("/").slice(0,3).join("/")+e.d.ServerRelativeUrl,a.AllFieldsUrl=e.d.ListItemAllFields.__deferred.uri,t.fields?i.ajax({url:a.AllFieldsUrl}):void o(a)}).then(function(e){SPExtend(!0,a,e.d);var r={ID:a.ID};return SPExtend(r,t.fields),i.update(r)}).then(function(e){if(e.failed.length>0)n("File '"+a.Url+"' added, but fields not updated: "+e.failed[0].errorMessage);else{e=e.passed[0];for(var t in e)a[t]=e[t];o(a)}})["catch"](function(e){n(e)})}else{if(t.fields&&!t.extendedFields)return void i.info().then(function(e){for(var r=e.length;r--;)t.fields[e[r].StaticName]&&(t.extendedFields+='<FieldInformation Type="'+e[r].Type+'" Value="'+t.fields[e[r].StaticName]+'" DisplayName="'+e[r].StaticName+'" InternalName="'+e[r].StaticName+'" />');t.extendedFields||delete t.fields,t.useCallback?i.createFile(t):i.createFile(t).then(function(e){o(e)},function(e){n(e)})});var s="/"+i.listID+"/"+t.filename;s=(i.url+s).replace(/([^:]\/)\//g,"$1"),"http"!==s.slice(0,4)&&(s=e.location.protocol+"//"+e.location.host+s),t.content=SPArrayBufferToBase64(t.content);var l="<SourceUrl>http://null</SourceUrl><DestinationUrls><string>"+s+'</string></DestinationUrls><Fields><FieldInformation Type="File" />'+t.extendedFields+"</Fields><Stream>"+t.content+"</Stream>";l=i._buildBodyForSOAP("CopyIntoItems",l),i.ajax({url:i.url+"/_vti_bin/copy.asmx",body:l,onprogress:function(e){e.lengthComputable&&t.progress(parseInt(e.loaded/e.total*100))},getXHR:t.getXHR,headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/CopyIntoItems"}}).then(function(e){var r=e.getElementsByTagName("CopyResult");r=r.length>0?r[0]:null,r&&"Success"!==r.getAttribute("ErrorCode")?n("[SharepointPlus 'createFile'] Error creating ("+s+"): "+r.getAttribute("ErrorCode")+" - "+r.getAttribute("ErrorMessage")):o({Url:s,Name:t.filename})},function(e){n(e)})}})})},createFolder:function(e){var t=this;return t._promise(function(i,o){if(t.needQueue)return t._addInQueue(arguments);if(e===r)throw"[SharepointPlus 'createFolder']: the folder path is required.";var n,a=e,s=[],l="";for("/"===a.charAt(0)&&(a=a.slice(1)),"/"===a.slice(-1)&&(a=a.slice(0,-1)),a=a.split("/"),n=0;n<a.length;n++)l+=(n>0?"/":"")+a[n],s.push({FSObjType:1,BaseName:l});t.add(s).then(function(t){"/"===e.charAt(0)&&(e=e.slice(1)),"/"===e.slice(-1)&&(e=e.slice(0,-1));var r;for(r=t.passed.length;r--;)if(t.passed[r].BaseName===e)return void i(t.passed[r]);for(r=t.failed.length;r--;)if(t.failed[r].BaseName===e)return void(t.failed[r].errorMessage.indexOf("0x8107090d")>-1?(t.failed[r].errorMessage="Folder '"+t.failed[r].BaseName+"' already exists.",i(t.failed[r])):o(t.failed[r].errorMessage));o("Unknown error")})["catch"](function(e){o(e)})})},checkin:function(e){var t=this;return t._promise(function(r,i){if(e=e||{},!e.destination)throw"[SharepointPlus 'checkin'] the file destination path is required.";return t.url&&!e.url&&(e.url=t.url),e.url?(e.comments=(e.comments||"").replace(/&/g,"&amp;"),void t.ajax({url:e.url+"/_vti_bin/Lists.asmx",body:t._buildBodyForSOAP("CheckInFile","<pageUrl>"+e.destination+"</pageUrl><comment>"+e.comments+"</comment><CheckinType>1</CheckinType>"),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/CheckInFile"}}).then(function(e){var t=e.getElementsByTagName("CheckInFileResult");t=t.length>0?t[0]:null,t&&"true"!=t.firstChild.nodeValue?i(t):r()},function(e){i(e)})):void t.getURL().then(function(r){return e.url=r,t.checkin(e)}).then(function(e){r(e)})["catch"](function(e){i(e)})})},addAttachment:function(e){var t=this;return t._promise(function(r,i){if(t.needQueue)return t._addInQueue(arguments);if(0===arguments.length)throw"[SharepointPlus 'addAttachment'] the arguments are mandatory.";if(!t.listID)throw"[SharepointPlus 'addAttachment'] the list ID/Name is required.";if(!t.url)throw"[SharepointPlus 'addAttachment'] not able to find the URL!";if(!e.ID)throw"[SharepointPlus 'addAttachment'] the item ID is required.";if(!e.filename)throw"[SharepointPlus 'addAttachment'] the filename is required.";if(!e.attachment)throw"[SharepointPlus 'addAttachment'] the ArrayBuffer of the attachment's content is required.";t.ajax({url:t.url+"/_vti_bin/Lists.asmx",body:t._buildBodyForSOAP("AddAttachment","<listName>"+t.listID+"</listName><listItemID>"+e.ID+"</listItemID><fileName>"+e.filename+"</fileName><attachment>"+SPArrayBufferToBase64(e.attachment)+"</attachment>"),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/AddAttachment"}}).then(function(e){var o=e.getElementsByTagName("AddAttachmentResult");o=o.length>0?o[0]:null;var n="";o&&(n=t.url+"/"+o.firstChild.nodeValue),n?r(n):i(o)},function(e){i(e)})})},getAttachment:function(e){var t=this;return t._promise(function(r,i){if(t.needQueue)return t._addInQueue(arguments);if(!t.listID)throw"[SharepointPlus 'getAttachment']: the list ID/Name is required";if(!t.url)throw"[SharepointPlus 'getAttachment']: not able to find the URL!";t.ajax({url:t.url+"/_vti_bin/lists.asmx",body:t._buildBodyForSOAP("GetAttachmentCollection","<listName>"+t.listID+"</listName><listItemID>"+e+"</listItemID>"),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/GetAttachmentCollection"}}).then(function(e){for(var t=[],i=0,o=e.getElementsByTagName("Attachment");i<o.length;i++)t.push(o[i].firstChild.nodeValue);r(t)},function(e){i(e)})})},getContentTypes:function(e){var t=this;return t._promise(function(r,i){if(t.needQueue)return t._addInQueue(arguments);if(!t.listID)throw"[SharepointPlus 'getContentTypes'] the list ID/name is required.";if(!t.url)throw"[SharepointPlus 'getContentTypes'] not able to find the URL!";if(e=e||{cache:!0},e.cache)for(var o=0;o<_SP_CACHE_CONTENTTYPES.length;o++)if(_SP_CACHE_CONTENTTYPES[o].list===t.listID&&_SP_CACHE_CONTENTTYPES[o].url===t.url)return void r(_SP_CACHE_CONTENTTYPES[o].contentTypes);t.ajax({url:t.url+"/_vti_bin/lists.asmx",body:t._buildBodyForSOAP("GetListContentTypes","<listName>"+t.listID+"</listName>"),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/GetListContentTypes"}}).then(function(e){for(var i,o=e.getElementsByTagName("ContentType"),n=0,a=[];n<o.length;n++)i=o[n].getAttribute("ID"),i&&a.push({ID:i,Name:o[n].getAttribute("Name"),Description:o[n].getAttribute("Description")});_SP_CACHE_CONTENTTYPES.push({list:t.listID,url:t.url,contentTypes:a}),r(a)},function(e){i(e)})})},getContentTypeInfo:function(e,t){var r=this;return r._promise(function(i,o){if(r.needQueue)return r._addInQueue(arguments);if(!r.listID)throw"[SharepointPlus 'getContentTypeInfo'] the list ID/Name is required.";if(arguments.length>=1&&"string"!=typeof e)throw"[SharepointPlus 'getContentTypeInfo'] the Content Type Name/ID is required.";if(!r.url)throw"[SharepointPlus 'getContentTypeInfo'] not able to find the URL!";if(t=t||{cache:!0},t.cache)for(var n=0;n<_SP_CACHE_CONTENTTYPE.length;n++)_SP_CACHE_CONTENTTYPE[n].list===r.listID&&_SP_CACHE_CONTENTTYPE[n].url===r.url&&_SP_CACHE_CONTENTTYPE[n].contentType===e&&i(_SP_CACHE_CONTENTTYPE[n].info);return"0x"!==e.slice(0,2)?void r.getContentTypes(t).then(function(n){for(var a=!1,s=n.length;s--;)if(n[s].Name===e){r.getContentTypeInfo(n[s].ID,t).then(function(e){i(e)},function(e){o(e)}),a=!0;break}if(!a)throw"[SharepointPlus 'getContentTypeInfo'] not able to find the Content Type called '"+e+"' at "+r.url}):void r.ajax({url:r.url+"/_vti_bin/lists.asmx",body:r._buildBodyForSOAP("GetListContentType","<listName>"+r.listID+"</listName><contentTypeId>"+e+"</contentTypeId>"),
 headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/GetListContentType"}}).then(function(t){var o,n,a,s,l,u,c,d,f,h,p,g,m=[],S=t.getElementsByTagName("Field"),_=0;for(o=0;o<S.length;o++)if(S[o].getAttribute("ID")){for(m[_]=[],c=m[_],d=S[o].attributes,n=d.length;n--;){if(f=d[n].nodeName,p=d[n].nodeValue,"Type"===f)switch(p){case"Choice":case"MultiChoice":for(c.FillInChoice=S[o].getAttribute("FillInChoice"),a=S[o].getElementsByTagName("CHOICE"),s=[],l=0;l<a.length;l++)s.push(a[l].firstChild.nodeValue);c.Choices=s;break;case"Lookup":case"LookupMulti":c.Choices={list:S[o].getAttribute("List"),field:S[o].getAttribute("ShowField")};break;default:c.Choices=[]}c[f]=p}if(h=S[o].getElementsByTagName("Default").length,h>0){for(g=S[o].getElementsByTagName("Default"),m[_].DefaultValue=[],u=0;h>u;u++)g[u].firstChild&&m[_].DefaultValue.push(g[u].firstChild.nodeValue);1===h&&(m[_].DefaultValue=m[_].DefaultValue[0])}else m[_].DefaultValue=null;_++}_SP_CACHE_CONTENTTYPE.push({list:r.listID,url:r.url,contentType:e,info:m}),i(m)},function(e){o(e)})})},info:function(){var e=this;return e._promise(function(t,r){if(e.needQueue)return e._addInQueue(arguments);if(!e.listID)throw"[SharepointPlus 'info'] the list ID/Name is required.";if(!e.url)throw"[SharepointPlus 'info'] not able to find the URL!";e.ajax({url:e.url+"/_vti_bin/lists.asmx",body:e._buildBodyForSOAP("GetList","<listName>"+e.listID+"</listName>"),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/GetList"}}).then(function(e){var r,i,o,n,a,s,l,u,c,d,f,h,p,g=[],m=e.getElementsByTagName("Field"),S=0,_=e.getElementsByTagName("List");for(_=_.length>0?_[0]:null,i=_.attributes,g._List={},l=0;l<i.length;l++)g._List[i[l].nodeName]=i[l].nodeValue;for(l=0;l<m.length;l++)if(m[l].getAttribute("ID")){for(g[S]=[],r=g[S],i=m[l].attributes,u=i.length;u--;){if(o=i[u].nodeName,n=i[u].nodeValue,"Type"===o)switch(n){case"Choice":case"MultiChoice":for(r.FillInChoice=m[l].getAttribute("FillInChoice"),c=m[l].getElementsByTagName("CHOICE"),d=[],f=0;f<c.length;f++)d.push(c[f].firstChild.nodeValue);r.Choices=d;break;case"Lookup":case"LookupMulti":r.Choices={list:m[l].getAttribute("List"),field:m[l].getAttribute("ShowField")};break;case"TaxonomyFieldType":case"TaxonomyFieldTypeMulti":for(c=m[l].getElementsByTagName("Property"),r.Property={},f=0;f<c.length;f++)h=c[f].getElementsByTagName("Name"),p=c[f].getElementsByTagName("Value"),h.length>0&&(r.Property[h[0].firstChild.nodeValue]=p.length>0?p[0].firstChild.nodeValue:null);break;default:r.Choices=[]}r[o]=n}if(a=m[l].getElementsByTagName("Default").length,a>0){s=m[l].getElementsByTagName("Default"),g[S].DefaultValue=[];for(var y=0;a>y;y++)s[y].firstChild&&g[S].DefaultValue.push(s[y].firstChild.nodeValue);1===a&&(g[S].DefaultValue=g[S].DefaultValue[0])}else g[S].DefaultValue=null;S++}t(g)},function(e){r(e)})})},view:function(e,t){var i=this;return i._promise(function(o,n){if(i.needQueue)return i._addInQueue(arguments);if(!i.listID)throw"[SharepointPlus 'view'] the list ID/Name is required.";if(!e)throw"[SharepointPlus 'view'] the view ID/Name is required.";var a,s=i.listID,l=!1;if(t=t||{},t.cache=t.cache!==!1,!i.url)throw"[SharepointPlus 'view'] not able to find the URL!";return t.cache&&(_SP_CACHE_SAVEDVIEW.forEach(function(t){t.url!==i.url||t.list!==s||t.viewID!==e&&t.viewName!==e||(l=!0,o(t.data))}),l)?void 0:"{"!==e.charAt(0)?void i.views().then(function(t){for(l=!1,a=t.length;a--;)if(t[a].Name===e){i.view(t[a].ID).then(function(e){o(e)},function(e){n(e)}),l=!0;break}if(!l)throw"[SharepointPlus 'view'] not able to find the view called '"+e+"' for list '"+i.listID+"' at "+i.url}):void i.ajax({url:i.url+"/_vti_bin/Views.asmx",body:i._buildBodyForSOAP("GetView","<listName>"+i.listID+"</listName><viewName>"+e+"</viewName>"),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/GetView"}}).then(function(t){var n,a,u=t.getElementsByTagName("View");u=u.length>0?u[0]:null;var c={DefaultView:"TRUE"==u.getAttribute("DefaultView"),Name:u.getAttribute("DisplayName"),ID:e,Type:u.getAttribute("Type"),Url:u.getAttribute("Url"),OrderBy:[],Fields:[],RowLimit:"",WhereCAML:"",Node:u},d=t.getElementsByTagName("ViewFields")[0].getElementsByTagName("FieldRef");for(n=0;n<d.length;n++)c.Fields.push(d[n].getAttribute("Name"));if(d=t.getElementsByTagName("OrderBy"),d=d.length>0?d[0]:null){for(d=d.getElementsByTagName("FieldRef"),n=0;n<d.length;n++)c.OrderBy.push(d[n].getAttribute("Name")+" "+(d[n].getAttribute("Ascending")==r?"ASC":"DESC"));c.OrderBy=c.OrderBy.join(",")}a=t.getElementsByTagName("Where"),a=a.length>0?a[0]:null,a&&(a=a.xml||(new XMLSerializer).serializeToString(a),a=a.match(/<Where [^>]+>(.*)<\/Where>/),2==a.length&&(c.WhereCAML=a[1])),l=!1,_SP_CACHE_SAVEDVIEW.forEach(function(t){t.url!==i.url||t.list!==s||t.viewID!==e&&t.viewName!==e||(t.data=c,l=!0)}),l||_SP_CACHE_SAVEDVIEW.push({url:i.url,list:i.listID,data:c,viewID:e,viewName:c.Name}),o(c)},function(e){n(e)})})},views:function(e){var t=this;return t._promise(function(r,i){if(t.needQueue)return t._addInQueue(arguments);if(!t.listID)throw"[SharepointPlus 'views'] the list ID/Name is required.";if(e=e||{},e.cache=e.cache!==!1,!t.url)throw"[SharepointPlus 'views'] not able to find the URL!";var o=!1;e.cache&&(_SP_CACHE_SAVEDVIEWS.forEach(function(e){e.url===t.url&&e.listID===t.listID&&(o=!0,r(e.data))}),o)||t.ajax({url:t.url+"/_vti_bin/Views.asmx",body:t._buildBodyForSOAP("GetViewCollection","<listName>"+t.listID+"</listName>"),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/GetViewCollection"}}).then(function(e){for(var i=[],o=e.getElementsByTagName("View"),n=0,a=!1;n<o.length;n++)i[n]={ID:o[n].getAttribute("Name"),Name:o[n].getAttribute("DisplayName"),Url:o[n].getAttribute("Url"),DefaultView:"TRUE"==o[n].getAttribute("DefaultView"),Type:o[n].getAttribute("Type"),Node:o[n]};_SP_CACHE_SAVEDVIEWS.forEach(function(e){e.url===t.url&&e.listID===t.listID&&(e.data=i,a=!0)}),a||_SP_CACHE_SAVEDVIEWS.push({url:t.url,listID:t.listID,data:i}),r(i)},function(e){i(e)})})},lists:function(e){var t=this;return t._promise(function(r,i){if(e=e||{},!e.url)return void t.getURL().then(function(r){return e.url=r,t.lists(e)}).then(function(e){r(e)})["catch"](function(e){i(e)});e.cache=e.cache!==!1;var o=!1;e.cache&&(_SP_CACHE_SAVEDLISTS.forEach(function(t){t.url===e.url&&(o=!0,r(t.data))}),o)||t.ajax({url:e.url+"/_vti_bin/lists.asmx",body:t._buildBodyForSOAP("GetListCollection",""),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/GetListCollection"}}).then(function(t){var i,n,a,s=[],l=t.getElementsByTagName("List");for(i=0;i<l.length;i++){for(s[i]={},a=l[i].attributes,n=a.length;n--;)s[i][a[n].nodeName]=a[n].nodeValue;s[i].Url=l[i].getAttribute("DefaultViewUrl"),s[i].Name=l[i].getAttribute("Title")}o=!1,e.cache&&_SP_CACHE_SAVEDLISTS.forEach(function(t){t.url===e.url&&(o=!0)}),o||_SP_CACHE_SAVEDLISTS.push({url:e.url,data:s}),r(s)}).then(function(e){i(e)})})},add:function(e,t){var i=this;return i._promise(function(o,n){if(i.needQueue)return i._addInQueue(arguments);if(!i.listID)throw"[SharepointPlus 'add'] the list ID/Name is required.";if(!i.url)throw"[SharepointPlus 'add'] not able to find the URL!";var a={};SPExtend(!0,a,t),a.escapeChar=a.escapeChar==r?!0:a.escapeChar,a.progress=a.progress||function(){},a.packetsize=a.packetsize||15,a.rootFolder=a.rootFolder||"",Array.isArray(e)||(e=[e]);var s,l,u,c,d,f,h=e.length;if(a.progressVar=a.progressVar||{current:0,max:h,passed:[],failed:[],eventID:"spAdd"+(""+Math.random()).slice(2)},h>a.packetsize)s=e.slice(0),l=s.splice(0,a.packetsize),_SP_ADD_PROGRESSVAR[a.progressVar.eventID]=function(e){return i.add(s,e)},e=l,h=e.length;else if(0===h)return a.progress(1,1),void o({passed:[],failed:[]});a.progressVar.current+=h;var p='<Batch OnError="Continue" ListVersion="1"  ViewName=""'+(a.rootFolder?' RootFolder="'+a.rootFolder+'"':"")+">";for(f=0;f<e.length;f++){p+='<Method ID="'+(f+1)+'" Cmd="New">',p+="<Field Name='ID'>New</Field>";for(d in e[f])e[f].hasOwnProperty(d)&&(u=d,c=e[f][d],Array.isArray(c)&&(c=0===c.length?"":";#"+c.join(";#")+";#"),a.escapeChar&&"string"==typeof c&&(c=i._cleanString(c)),p+="<Field Name='"+u+"'>"+c+"</Field>");p+="</Method>"}p+="</Batch>",i.ajax({url:i.url+"/_vti_bin/lists.asmx",body:i._buildBodyForSOAP("UpdateListItems","<listName>"+i.listID+"</listName><updates>"+p+"</updates>"),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/UpdateListItems"}}).then(function(t){var r,i,s=t.getElementsByTagName("Result"),l=s.length,u=a.progressVar.passed,c=a.progressVar.failed;for(r=0;l>r;r++)"0x00000000"===s[r].getElementsByTagName("ErrorCode")[0].firstChild.nodeValue?(i=s[r].getElementsByTagName("z:row"),0==i.length&&(i=s[r].getElementsByTagName("row")),e[r]&&(e[r].ID=i[0].getAttribute("ows_ID"),e[r].raw=i[0],u.push(e[r]))):e[r]&&(e[r].errorMessage=s[r].getElementsByTagName("ErrorText")[0].firstChild.nodeValue,c.push(e[r]));a.progress(a.progressVar.current,a.progressVar.max),a.progressVar.current<a.progressVar.max?_SP_ADD_PROGRESSVAR[a.progressVar.eventID]&&_SP_ADD_PROGRESSVAR[a.progressVar.eventID](a).then(function(e){o(e)},function(e){n(e)}):(_SP_ADD_PROGRESSVAR[a.progressVar.eventID]&&delete _SP_ADD_PROGRESSVAR[a.progressVar.eventID],o({passed:u,failed:c}))},function(e){n(e)})})},update:function(e,t){var i=this;return i._promise(function(o,n){if(i.needQueue)return i._addInQueue(arguments);if(!i.listID)throw"[SharepointPlus 'update'] the list ID/name is required.";if(!i.url)throw"[SharepointPlus 'update'] not able to find the URL!";var a={};SPExtend(!0,a,t),a.where=a.where||"",a.escapeChar=a.escapeChar==r?!0:a.escapeChar,a.progress=a.progress||function(){},a.packetsize=a.packetsize||15,Array.isArray(e)||(e=[e]);var s,l,u,c,d,f,h=e.length;if(1===h&&a.where)return delete e[0].ID,void i.get({fields:"ID",where:a.where}).then(function(t){for(var r,o=function(e){var t={};for(var r in e)t[r]=e[r];return t},n=[],s=t.length;s--;)r=o(e[0]),r.ID=t[s].getAttribute("ID"),n.push(r);return delete a.where,i.update(n,a)}).then(function(e){o(e)})["catch"](function(e){n(e)});if(a.progressVar=a.progressVar||{current:0,max:h,passed:[],failed:[],eventID:"spUpdate"+(""+Math.random()).slice(2)},h>a.packetsize)s=e.slice(0),l=s.splice(0,a.packetsize),_SP_UPDATE_PROGRESSVAR[a.progressVar.eventID]=function(e){return i.update(s,e)},e=l,h=e.length;else if(0==h)return void o({passed:[],failed:[]});a.progressVar.current+=h;var p='<Batch OnError="Continue" ListVersion="1"  ViewName="">';for(f=0;h>f;f++){if(p+='<Method ID="'+(f+1)+'" Cmd="Update">',!e[f].ID)throw"[SharepointPlus 'update'] you have to provide the item ID called 'ID'";for(d in e[f])e[f].hasOwnProperty(d)&&(u=d,c=e[f][d],Array.isArray(c)&&(c=0===c.length?"":";#"+c.join(";#")+";#"),a.escapeChar&&"string"==typeof c&&(c=i._cleanString(c)),p+="<Field Name='"+u+"'>"+c+"</Field>");p+="</Method>"}p+="</Batch>",i.ajax({url:i.url+"/_vti_bin/lists.asmx",body:i._buildBodyForSOAP("UpdateListItems","<listName>"+i.listID+"</listName><updates>"+p+"</updates>"),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/UpdateListItems"}}).then(function(t){var r,i=t.getElementsByTagName("Result"),s=i.length,l=a.progressVar.passed,u=a.progressVar.failed;for(r=0;s>r;r++)if("0x00000000"===i[r].getElementsByTagName("ErrorCode")[0].firstChild.nodeValue&&e[r]){var c=i[r].getElementsByTagName("z:row");0===c.length&&(c=i[r].getElementsByTagName("row")),e[r].raw=c[0],l.push(e[r])}else e[r]&&(e[r].errorMessage=i[r].getElementsByTagName("ErrorText")[0].firstChild.nodeValue,u.push(e[r]));a.progress(a.progressVar.current,a.progressVar.max),a.progressVar.current<a.progressVar.max?_SP_UPDATE_PROGRESSVAR[a.progressVar.eventID]&&_SP_UPDATE_PROGRESSVAR[a.progressVar.eventID](a).then(function(e){o(e)},function(e){n(e)}):(_SP_UPDATE_PROGRESSVAR[a.progressVar.eventID]&&delete _SP_UPDATE_PROGRESSVAR[a.progressVar.eventID],o({passed:l,failed:u}))},function(e){n(e)})})},history:function(e){var t=this;return t._promise(function(r,i){if(t.needQueue)return t._addInQueue(arguments);if(!t.listID)throw"[SharepointPlus 'history'] the list ID/Name is required.";if(e=e||{},!e.ID||!e.Name)throw"[SharepointPlus 'history'] you must provide the item ID and field Name.";t.ajax({url:t.url+"/_vti_bin/lists.asmx",body:t._buildBodyForSOAP("GetVersionCollection","<strlistID>"+t.listID+"</strlistID><strlistItemID>"+e.ID+"</strlistItemID><strFieldName>"+e.Name+"</strFieldName>"),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/GetVersionCollection"}}).then(function(e){r(e.getElementsByTagName("Version"))},function(e){i(e)})})},moderate:function(e,t){var r=this;return r._promise(function(i,o){if(r.needQueue)return r._addInQueue(arguments);if(!r.listID)throw"[SharepointPlus 'moderate'] the list ID/Name is required.";if(t=t||{},!r.url)throw"[SharepointPlus 'moderate'] not able to find the URL!";t.progress=t.progress||function(){},Array.isArray(e)||(e=[e]);var a,s,l,u,c,d,f=e.length;if(t.progressVar=t.progressVar||{current:0,max:f,passed:[],failed:[],eventID:"spModerate"+(""+Math.random()).slice(2)},f>15)return a=e.slice(0),s=a.splice(0,15),_SP_MODERATE_PROGRESSVAR[t.progressVar.eventID]=function(e){return r.moderate(a,e)},void r.moderate(s,t);if(0===f)return void t.after({passed:[],failed:[]});t.progressVar.current+=f;var h='<Batch OnError="Continue" ListVersion="1"  ViewName="">';for(d=0;f>d;d++){if(h+='<Method ID="'+(d+1)+'" Cmd="Moderate">',!e[d].ID)throw"[SharepointPlus 'moderate'] you have to provide the item ID called 'ID'";if("undefined"==typeof e[d].ApprovalStatus)throw"[SharepointPlus 'moderate'] you have to provide the approval status 'ApprovalStatus' (Approved, Rejected, Pending, Draft or Scheduled)";for(c in e[d]){if(e[d].hasOwnProperty(c)&&(l=c,u=e[d][c],"ApprovalStatus"==l))switch(l="_ModerationStatus",u.toLowerCase()){case"approve":case"approved":u=0;break;case"reject":case"deny":case"denied":case"rejected":u=1;break;case"pending":u=2;break;case"draft":u=3;break;case"scheduled":u=4;break;default:u=2}h+="<Field Name='"+l+"'>"+u+"</Field>"}h+="</Method>"}h+="</Batch>",r.ajax({url:r.url+"/_vti_bin/lists.asmx",body:r._buildBodyForSOAP("UpdateListItems","<listName>"+r.listID+"</listName><updates>"+h+"</updates>"),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/UpdateListItems"}}).then(function(r){var a,s,l=r.getElementsByTagName("Result"),u=l.length,c=t.progressVar.passed,d=t.progressVar.failed;for(s=0;u>s;s++){a=l[s].getElementsByTagName("z:row"),0==a.length&&(a=r.getElementsByTagName("row"));var f=n(a[0]);"0x00000000"==l[s].getElementsByTagName("ErrorCode")[0].firstChild.nodeValue?c.push(f):(e[s].errorMessage=l[s].getElementsByTagName("ErrorText")[0].firstChild.nodeValue,d.push(e[s]))}t.progress(t.progressVar.current,t.progressVar.max),t.progressVar.current<t.progressVar.max?_SP_MODERATE_PROGRESSVAR[t.progressVar.eventID]&&_SP_MODERATE_PROGRESSVAR[t.progressVar.eventID](t).then(function(e){i(e)},function(e){o(e)}):(_SP_MODERATE_PROGRESSVAR[t.progressVar.eventID]&&delete _SP_MODERATE_PROGRESSVAR[t.progressVar.eventID],i({passed:c,failed:d}))},function(e){o(e)})})},remove:function(e,t){var i=this;return i._promise(function(o,n){if(i.needQueue)return i._addInQueue(arguments);if(!i.url)throw"[SharepointPlus 'remove'] not able to find the URL!";!t&&e.where&&(t=e,e=[]);var a={};SPExtend(!0,a,t),a.progress=a.progress||function(){},a.packetsize=a.packetsize||15,Array.isArray(e)||(e=[e]);var s,l,u,c=e.length;if(a.where)return 1===c&&delete e[0].ID,void i.get({fields:"ID,FileRef",where:a.where}).then(function(t){for(var r,s,l=function(e){var t={};for(var r in e)t[r]=e[r];return t},u=[],c=t.length;c--;)s=l(e[0]),s.ID=t[c].getAttribute("ID"),r=t[c].getAttribute("FileRef"),r&&(s.FileRef=i.cleanResult(r)),u.push(s);delete a.where,i.remove(u,a).then(function(e){o(e)},function(e){n(e)})});if(0===c)return void o({passed:[],failed:[]});a.progressVar=a.progressVar||{current:0,max:c,passed:[],failed:[],eventID:"spRemove"+(""+Math.random()).slice(2)},c>a.packetsize&&(s=e.slice(0),l=s.splice(0,a.packetsize),_SP_REMOVE_PROGRESSVAR[a.progressVar.eventID]=function(e){return i.remove(s,e)},e=l,c=e.length),a.progressVar.current+=c;var d='<Batch OnError="Continue" ListVersion="1"  ViewName="">';for(u=0;u<e.length;u++){if(d+='<Method ID="'+(u+1)+'" Cmd="Delete">',e[u].ID==r)throw"Error 'delete': you have to provide the item ID called 'ID'";d+="<Field Name='ID'>"+e[u].ID+"</Field>",e[u].FileRef!=r&&(d+="<Field Name='FileRef'>"+e[u].FileRef+"</Field>"),d+="</Method>"}d+="</Batch>",i.ajax({url:i.url+"/_vti_bin/lists.asmx",body:i._buildBodyForSOAP("UpdateListItems","<listName>"+i.listID+"</listName><updates>"+d+"</updates>"),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/UpdateListItems"}}).then(function(t){var r,i=t.getElementsByTagName("Result"),s=i.length,l=a.progressVar.passed,u=a.progressVar.failed;for(r=0;s>r;r++)"0x00000000"===i[r].getElementsByTagName("ErrorCode")[0].firstChild.nodeValue?l.push(e[r]):(e[r].errorMessage=i[r].getElementsByTagName("ErrorText")[0].firstChild.nodeValue,u.push(e[r]));a.progress(a.progressVar.current,a.progressVar.max),a.progressVar.current<a.progressVar.max?_SP_REMOVE_PROGRESSVAR[a.progressVar.eventID]&&(a.useCallback?_SP_REMOVE_PROGRESSVAR[a.progressVar.eventID](a):_SP_REMOVE_PROGRESSVAR[a.progressVar.eventID](a).then(function(e){o(e)},function(e){n(e)})):(_SP_REMOVE_PROGRESSVAR[a.progressVar.eventID]&&delete _SP_REMOVE_PROGRESSVAR[a.progressVar.eventID],o({passed:l,failed:u}))})})},usergroups:function(e,t){var r=this;return r._promise(function(i,o){if(!e)throw"[SharepointPlus 'usergroups']: the username is required.";if(t=t||{},t.cache=t.cache!==!1,!t.url)return void r.getURL().then(function(t){return r.usergroups(e,{url:t})}).then(function(e){i(e)})["catch"](function(e){o(e)});e=e.toLowerCase(),t.url=t.url.toLowerCase();var n=!1;t.cache&&_SP_CACHE_USERGROUPS.forEach(function(r){r.user===e&&r.url===t.url&&(i(r.data),n=!0)}),n||r.ajax({url:t.url+"/_vti_bin/usergroup.asmx",body:r._buildBodyForSOAP("GetGroupCollectionFromUser","<userLoginName>"+e+"</userLoginName>","http://schemas.microsoft.com/sharepoint/soap/directory/"),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/directory/GetGroupCollectionFromUser"}}).then(function(r){var o=[];r=r.getElementsByTagName("Group");for(var a=0,s=r.length;s>a;a++)o.push(r[a].getAttribute("Name"));n=!1,_SP_CACHE_USERGROUPS.forEach(function(r){r.user===e&&r.url===t.url&&(r.data=o,n=!0)}),n||_SP_CACHE_USERGROUPS.push({user:e,url:t.url,data:o}),i(o)},function(e){o(e)})})},workflowStatusToText:function(e){switch(e=1*e){case 0:return"Not Started";case 1:return"Failed On Start";case 2:return"In Progress";case 3:return"Error Occurred";case 4:return"Stopped By User";case 5:return"Completed";case 6:return"Failed On Start Retrying";case 7:return"Error Occurred Retrying";case 8:return"View Query Overflow";case 15:return"Canceled";case 16:return"Approved";case 17:return"Rejected";default:return"Unknown"}},getWorkflowID:function(t){var r=this;return r._promise(function(i,o){if(r.needQueue)return r._addInQueue(arguments);if(!r.listID)throw"[SharepointPlus 'getWorkflowID'] the list ID/Name is required.";if(!r.url)throw"[SharepointPlus 'getWorkflowID'] not able to find the URL!";if(t=t||{},!t.ID||!t.workflowName)throw"[SharepointPlus 'getWorkflowID'] all parameters are mandatory";r.get({fields:"FieldRef",where:"ID = "+t.ID}).then(function(n){if(0===n.length)throw"[SharepointPlus 'getWorkflowID'] I'm not able to find the item ID "+t.ID;var a=r.cleanResult(n[0].getAttribute("FileRef"));r.url.startsWith("http")?a.startsWith("http")||(a=r.url+a):a=e.location.href.split("/").slice(0,3).join("/")+"/"+a,r.ajax({url:r.url+"/_vti_bin/Workflow.asmx",body:r._buildBodyForSOAP("GetWorkflowDataForItem","<item>"+a+"</item>","http://schemas.microsoft.com/sharepoint/soap/workflow/"),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/workflow/GetWorkflowDataForItem"}}).then(function(e){var o,n,s={},l=e.getElementsByTagName("WorkflowTemplate");if(0===l.length){var u=SP.ClientContext.get_current(),c=u.get_web().get_lists(),d=c.getByTitle(r.listID),f=d.getItemById(t.ID);u.load(d),u.load(f);var h=d.get_workflowAssociations();u.load(h),u.executeQueryAsync(function(){for(var e=h.getEnumerator();e.moveNext();){var r=e.get_current();if(r.get_name()===t.workflowName){s={fileRef:a,description:r.get_description(),workflowID:"{"+r.get_id().toString()+"}",instances:[]};break}}i(s)},function(){throw"[SharepointPlus 'getWorkflowID'] Problem while dealing with SP.ClientContext.get_current()"})}else{for(o=l.length;o--;)l[o].getAttribute("Name")==t.workflowName&&(s={fileRef:a,description:l[o].getAttribute("Description"),workflowID:"{"+l[o].getElementsByTagName("WorkflowTemplateIdSet")[0].getAttribute("TemplateId")+"}",instances:[]});if(!s.fileRef)throw"[SharepointPlus 'getWorkflowID'] it seems the requested workflow ('"+t.workflowName+"') doesn't exist!";for(l=e.getElementsByTagName("Workflow"),o=0;o<l.length;o++)n=l[o],s.instances.push({StatusPageUrl:n.getAttribute("StatusPageUrl"),Id:n.getAttribute("Id"),TemplateId:n.getAttribute("TemplateId"),ListId:n.getAttribute("ListId"),SiteId:n.getAttribute("SiteId"),WebId:n.getAttribute("WebId"),ItemId:n.getAttribute("ItemId"),ItemGUID:n.getAttribute("ItemGUID"),TaskListId:n.getAttribute("TaskListId"),AdminTaskListId:n.getAttribute("AdminTaskListId"),Author:n.getAttribute("Author"),Modified:n.getAttribute("Modified"),Created:n.getAttribute("Created"),StatusVersion:n.getAttribute("StatusVersion"),Status1:{code:n.getAttribute("Status1"),text:r.workflowStatusToText(n.getAttribute("Status1"))},Status2:{code:n.getAttribute("Status2"),text:r.workflowStatusToText(n.getAttribute("Status2"))},Status3:{code:n.getAttribute("Status3"),text:r.workflowStatusToText(n.getAttribute("Status3"))},Status4:{code:n.getAttribute("Status4"),text:r.workflowStatusToText(n.getAttribute("Status4"))},Status5:{code:n.getAttribute("Status5"),text:r.workflowStatusToText(n.getAttribute("Status5"))},Status6:{code:n.getAttribute("Status6"),text:r.workflowStatusToText(n.getAttribute("Status6"))},Status7:{code:n.getAttribute("Status7"),text:r.workflowStatusToText(n.getAttribute("Status7"))},Status8:{code:n.getAttribute("Status8"),text:r.workflowStatusToText(n.getAttribute("Status8"))},Status9:{code:n.getAttribute("Status9"),text:r.workflowStatusToText(n.getAttribute("Status9"))},Status10:{code:n.getAttribute("Status10"),text:r.workflowStatusToText(n.getAttribute("Status10"))},TextStatus1:n.getAttribute("TextStatus1"),TextStatus2:n.getAttribute("TextStatus2"),TextStatus3:n.getAttribute("TextStatus3"),TextStatus4:n.getAttribute("TextStatus4"),TextStatus5:n.getAttribute("TextStatus5"),Modifications:n.getAttribute("Modifications"),InternalState:n.getAttribute("InternalState"),ProcessingId:n.getAttribute("ProcessingId")});i(s)}},function(){o("[SharepointPlus 'getWorkflowID'] Something went wrong with the request over the Workflow Web Service...")})})})},startWorkflow:function(e){var t=this;return t._promise(function(r,i){if(t.needQueue)return t._addInQueue(arguments);if(!t.url)throw"[SharepointPlus 'startWorkflow'] not able to find the URL!";if(!t.listID)return e.platformType=2010,t.startWorkflow2013(e);if(e=e||{},!e.workflowName&&!e.workflowID)throw"[SharepointPlus 'startWorkflow'] Please provide the workflow name";if(!e.ID)throw"[SharepointPlus 'startWorkflow'] Please provide the item ID";if(!e.fileRef&&!e.workflowID)return void t.getWorkflowID({ID:e.ID,workflowName:e.workflowName}).then(function(o){e.fileRef=o.fileRef,e.workflowID=o.workflowID,t.startWorkflow(e).then(function(e){r(e)},function(e){i(e)})});var o,n,a="<root />";if(e.parameters){for(Array.isArray(e.parameters)||(e.parameters=[e.parameters]),o=e.parameters.slice(0),a="<Data>",n=0;n<o.length;n++)a+="<"+o[n].name+">"+o[n].value+"</"+o[n].name+">";a+="</Data>"}t.ajax({url:t.url+"/_vti_bin/Workflow.asmx",body:t._buildBodyForSOAP("StartWorkflow","<item>"+e.fileRef+"</item><templateId>"+e.workflowID+"</templateId><workflowParameters>"+a+"</workflowParameters>","http://schemas.microsoft.com/sharepoint/soap/workflow/"),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/workflow/StartWorkflow"}}).then(function(){r()},function(e){i(e)})})},startWorkflow2013:function(e){var t=this;return t._promise(function(i,o){if(t.needQueue)return t._addInQueue(arguments);if(!t.url)throw"[SharepointPlus 'startWorkflow2013'] not able to find the URL!";if(e=e||{},e.platformType=e.platformType||2013,!e.workflowName)throw"[SharepointPlus 'startWorkflow2013'] Please provide the workflow name.";if(t.listID&&!e.ID)throw"Error 'startWorkflow2013': Please provide the item ID.";if("undefined"==typeof SP||"undefined"==typeof SP.SOD)throw"[SharepointPlus 'startWorkflow2013']: SP.SOD.executeFunc is required (from the Microsoft file called init.js)";SP.SOD.executeFunc("sp.js","SP.ClientContext",function(){SP.SOD.registerSod("sp.workflowservices.js",SP.Utilities.Utility.getLayoutsPageUrl("sp.workflowservices.js")),SP.SOD.executeFunc("sp.workflowservices.js","SP.WorkflowServices.WorkflowServicesManager",function(){var n=new SP.ClientContext(t.url),a=n.get_web(),s=SP.WorkflowServices.WorkflowServicesManager.newObject(n,a);n.load(s);var l=s.getWorkflowSubscriptionService().enumerateSubscriptions();n.load(l),n.executeQueryAsync(function(){var t,a,u=l.getEnumerator(),c={},d=!1,f=e.workflowName.toLowerCase();if(e.parameters)for(e.parameters.length===r&&(e.parameters=[e.parameters]),a=0;a<e.parameters.length;a++)c[e.parameters[a].name]=e.parameters[a].value;if(2010==e.platformType){var h=s.getWorkflowInteropService();h.startWorkflow(f,null,null,null,c),n.executeQueryAsync(function(){i()},function(t,r){var i=r.get_message();"associationName"===i&&(i="No workflow found with the name '"+e.workflowName+"'"),o(i)})}else{for(;u.moveNext();)if(t=u.get_current(),t.get_name().toLowerCase()===f){e.ID?s.getWorkflowInstanceService().startWorkflowOnListItem(t,e.ID,c):s.getWorkflowInstanceService().startWorkflow(t,c),n.executeQueryAsync(function(){i()},function(e,t){o(t.get_message())}),d=!0;break}d||o("No workflow found with the name '"+e.workflowName+"'")}},function(e,t){o(t.get_message())})})})})},distributionLists:function(e,t){var r=this;return r._promise(function(i,o){if(!e)throw"[SharepointPlus 'distributionLists'] the username is required.";if(t=t||{},!t.url)return void r.getURL().then(function(i){return t.url=i,r.distributionLists(e,t)}).then(function(e){i(e)})["catch"](function(e){o(e)});e=e.toLowerCase(),t.url=t.url.toLowerCase(),t.cache=t.cache!==!1;var n=!1;t.cache&&_SP_CACHE_DISTRIBUTIONLISTS.forEach(function(r){r.user===e&&r.url===t.url&&(i(r.data),n=!0)}),n||r.ajax({url:t.url+"/_vti_bin/UserProfileService.asmx",body:r._buildBodyForSOAP("GetCommonMemberships","<accountName>"+e+"</accountName>","http://microsoft.com/webservices/SharePointPortalServer/UserProfileService"),headers:{SOAPAction:"http://microsoft.com/webservices/SharePointPortalServer/UserProfileService/GetUserMemberships"}}).then(function(r){var o=[];r=r.getElementsByTagName("MembershipData");for(var a=0,s=r.length;s>a;a++)"DistributionList"===r[a].getElementsByTagName("Source")[0].firstChild.nodeValue&&o.push({SourceReference:r[a].getElementsByTagName("SourceReference")[0].firstChild.nodeValue,DisplayName:r[a].getElementsByTagName("DisplayName")[0].firstChild.nodeValue,MailNickname:r[a].getElementsByTagName("MailNickname")[0].firstChild.nodeValue,Url:r[a].getElementsByTagName("Url")[0].firstChild.nodeValue});n=!1,_SP_CACHE_DISTRIBUTIONLISTS.forEach(function(r){r.user===e&&r.url===t.url&&(r.data=o,n=!0)}),n||_SP_CACHE_DISTRIBUTIONLISTS.push({user:e,url:t.url,data:o}),i(o)},function(e){o(e)})})},groupMembers:function(e,t){var r=this;return r._promise(function(i,o){if(!e)throw"[SharepointPlus 'groupMembers'] the groupname is required.";if(t=t||{},t.cache=t.cache!==!1,!t.url&&!r.url)return void r.getURL().then(function(i){return t.url=i,r.groupMembers(e,t)}).then(function(e){i(e)})["catch"](function(e){o(e)});e=e.toLowerCase(),t.url=t.url.toLowerCase();var n=!1;t.cache&&_SP_CACHE_GROUPMEMBERS.forEach(function(r){r.group===e&&r.url===t.url&&(i(r.data),n=!0)}),n||r.ajax({url:t.url+"/_vti_bin/usergroup.asmx",body:r._buildBodyForSOAP("GetUserCollectionFromGroup","<groupName>"+r._cleanString(e)+"</groupName>","http://schemas.microsoft.com/sharepoint/soap/directory/"),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/directory/GetUserCollectionFromGroup"}}).then(function(r){var o=[];r=r.getElementsByTagName("User");for(var a=0,s=r.length;s>a;a++)o.push({ID:r[a].getAttribute("ID"),Name:r[a].getAttribute("Name"),LoginName:r[a].getAttribute("LoginName"),Email:r[a].getAttribute("Email")});n=!1,_SP_CACHE_GROUPMEMBERS.forEach(function(r){r.group===e&&r.url===t.url&&(r.data=o,n=!0)}),n||_SP_CACHE_GROUPMEMBERS.push({group:e,url:t.url,data:o}),i(o)},function(e){o(e)})})},isMember:function(e){var t=this;return t._promise(function(r,i){if(e=e||{},!e.user)throw"[SharepointPlus 'isMember'] the user is required.";if(!e.group)throw"[SharepointPlus 'isMember'] the group is required.";if(e.cache=e.cache!==!1,!e.url)return void t.getURL().then(function(r){return e.url=r,t.isMember(e)}).then(function(e){r(e)})["catch"](function(e){i(e)});e.group=e.group.toLowerCase();var o=[];t.usergroups(e.user,{cache:e.cache}).then(function(i){for(var o=i.length;o--;)if(i[o].toLowerCase()===e.group)return r(!0),Promise.resolve(!1);return t.groupMembers(e.group,{cache:e.cache})}).then(function(r){if(r===!1)return Promise.resolve(!1);for(var i=r.length;i--;)o.push(r[i].Name.toLowerCase());return t.distributionLists(e.user,{cache:e.cache})}).then(function(e){if(e!==!1){for(var t=!1,i=e.length;i--;)o.indexOf(e[i].DisplayName.toLowerCase())>-1&&(r(!0),t=!0);t||r(!1)}})["catch"](function(e){i(e)})})},people:function(e,t){var r=this;return r._promise(function(i,o){return 1===arguments.length&&"object"==typeof e&&(t=e,e=""),e=e||"",t=t||{},t.url?void r.ajax({url:t.url+"/_vti_bin/UserProfileService.asmx",body:r._buildBodyForSOAP("GetUserProfileByName","<AccountName>"+e+"</AccountName>","http://microsoft.com/webservices/SharePointPortalServer/UserProfileService"),headers:{SOAPAction:"http://microsoft.com/webservices/SharePointPortalServer/UserProfileService/GetUserProfileByName"}}).then(function(e){var t,r,o=[];e=e.getElementsByTagName("PropertyData");for(var n=0,a=e.length;a>n;n++)t=e[n].getElementsByTagName("Name")[0].firstChild.nodeValue,r=e[n].getElementsByTagName("Value"),r=r.length>0?r[0]:null,r=r&&r.firstChild?r.firstChild.nodeValue:"No Value",o.push(t),o[t]=r;i(o)},function(e){o(e)}):void r.getURL().then(function(i){return t.url=i,r.people(e,t)}).then(function(e){i(e)})["catch"](function(e){o(e)})})},getUserInfo:function(e,t){var r=this;return r._promise(function(i,o){if("string"!=typeof e)throw"[SharepointPlus 'getUserInfo'] the username is required.";return t=t||{},t.url?void r.ajax({url:t.url+"/_vti_bin/usergroup.asmx",body:r._buildBodyForSOAP("GetUserInfo","<userLoginName>"+e+"</userLoginName>","http://schemas.microsoft.com/sharepoint/soap/directory/")}).then(function(e){e=e.getElementsByTagName("User"),0===e.length?o("[SharepointPlus 'getUserInfo'] nothing returned?!"):i({ID:e[0].getAttribute("ID"),Sid:e[0].getAttribute("Sid"),Name:e[0].getAttribute("Name"),LoginName:e[0].getAttribute("LoginName"),Email:e[0].getAttribute("Email"),Notes:e[0].getAttribute("Notes"),IsSiteAdmin:e[0].getAttribute("IsSiteAdmin"),IsDomainGroup:e[0].getAttribute("IsDomainGroup"),Flags:e[0].getAttribute("Flags")})},function(e){o(e)}):void r.getURL().then(function(i){return t.url=i,r.getUserInfo(e,t)}).then(function(e){i(e)})["catch"](function(e){o(e)})})},whoami:function(e){return this.people("",e)},regionalSettings:function(e){var r=this;return r._promise(function(i,o){return _SP_CACHE_REGIONALSETTINGS?void i(_SP_CACHE_REGIONALSETTINGS):e?void r.ajax({url:e+"/_layouts/regionalsetng.aspx?Type=User"}).then(function(e){var r={lcid:"",cultureInfo:"",
 timeZone:"",calendar:"",alternateCalendar:""},o=t.createElement("div");o.innerHTML=e;var n,a,s=function(e){var t=o.querySelector("select[id$='"+e+"']");return t.options[t.selectedIndex].innerHTML};for(r.lcid=o.querySelector("select[id$='LCID']").value,r.cultureInfo=s("LCID"),r.timeZone=s("TimeZone"),r.calendar=s("DdlwebCalType"),r.alternateCalendar=s("DdlwebAltCalType"),n=t.querySelectorAll("input[id*='ChkListWeeklyMultiDays']"),r.workWeek={days:[],firstDayOfWeek:"",firstWeekOfYear:"",startTime:"",endTime:""},a=0;a<n.length;a++)n[a].checked&&r.workWeek.days.push(n[a].nextSibling.querySelector("abbr").getAttribute("title"));r.workWeek.firstDayOfWeek=s("DdlFirstDayOfWeek"),r.workWeek.firstWeekOfYear=s("DdlFirstWeekOfYear"),r.workWeek.startTime=o.querySelector("select[id$='DdlStartTime']").value,r.workWeek.endTime=o.querySelector("select[id$='DdlEndTime']").value,r.timeFormat=s("DdlTimeFormat"),_SP_CACHE_REGIONALSETTINGS=r,i(r)},function(e){o(e)}):void r.getURL().then(function(e){return r.regionalSettings(e)}).then(function(e){i(e)})["catch"](function(e){o(e)})})},regionalDateFormat:function(e){var r=this;return r._promise(function(i,o){if(_SP_CACHE_DATEFORMAT)return void i(_SP_CACHE_DATEFORMAT);if(!e)return void r.getURL().then(function(e){return r.regionalDateFormat(e)}).then(function(e){i(e)})["catch"](function(e){o(e)});var n="";return"undefined"!=typeof _spRegionalSettings?n=_spRegionalSettings.localeId:_SP_CACHE_REGIONALSETTINGS&&(n=_SP_CACHE_REGIONALSETTINGS.lcid),n?void r.ajax({url:e+"/_layouts/iframe.aspx?cal=1&date=1/1/2000&lcid="+n}).then(function(e){var r=t.createElement("div");r.innerHTML=e;var o=r.querySelector('a[id="20000103"]').getAttribute("href").replace(/javascript:ClickDay\('(.*)'\)/,"$1"),n=/\\u([\d\w]{4})/gi;o=o.replace(n,function(e,t){return String.fromCharCode(parseInt(t,16))}),o=unescape(o),o=o.replace(/20/,"YY"),o=o.replace(/00/,"YY"),o=o.replace(/03/,"DD"),o=o.replace(/3/,"D"),o=o.replace(/01/,"MM"),o=o.replace(/1/,"M"),_SP_CACHE_DATEFORMAT=o,i(o)},function(e){o(e)}):void r.regionalSettings(e).then(function(){return r.regionalDateFormat(e)}).then(function(e){i(e)})["catch"](function(e){o(e)})})},addressbook:function(e,t){var r=this;return r._promise(function(i,o){switch(arguments.length){case 0:e="",t={};break;case 1:"string"==typeof e?t={}:(t=e,e="")}return t.url?(t.limit=t.limit||10,t.type=t.type||"User",void r.ajax({url:t.url+"/_vti_bin/People.asmx",body:r._buildBodyForSOAP("SearchPrincipals","<searchText>"+e+"</searchText><maxResults>"+t.limit+"</maxResults><principalType>"+t.type+"</principalType>"),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/SearchPrincipals"}}).then(function(e){var t,r,o,n=[];e=e.getElementsByTagName("PrincipalInfo");for(var a=0,s=e.length;s>a;a++){t=e[a].childNodes,n[a]=[];for(var l=0,u=t.length;u>l;l++)r=t[l].nodeName,o=t[l].firstChild,o&&(o=o.nodeValue),n[a].push(r),n[a][r]=o}i(n)},function(e){o(e)})):void r.getURL().then(function(i){return t.url=i,r.addressbook(e,t)}).then(function(e){i(e)})["catch"](function(e){o(e)})})},reset:function(){var e=this;return e.data=[],e.length=0,e.listID="",e.needQueue=!1,e.listQueue=[],delete e.url,e},toDate:function(e,t){if(!e)return"";if(e instanceof Date)return e;if("datetime;#"===e.slice(0,10)&&(e=e.slice(10)),19!=e.length&&20!=e.length)throw"[SharepointPlus toDate] '"+e+"' is invalid.";var r=e.substring(0,4),i=e.substring(5,7),o=e.substring(8,10),n=e.substring(11,13),a=e.substring(14,16),s=e.substring(17,19);return e.indexOf("Z")>-1||t?new Date(Date.UTC(r,i-1,o,n,a,s)):new Date(r,i-1,o,n,a,s)},toSPDate:function(e,t){if(!e||"object"!=typeof e||"function"!=typeof e.getFullYear)return"";var r=function(e){return 1==e.toString().length&&(e="0"+e),e},i=r(e.getMonth()+1),o=r(e.getDate()),n=e.getFullYear(),a=r(e.getHours()),s=r(e.getMinutes()),l=r(e.getSeconds());return n+"-"+i+"-"+o+(t?"T"+a+":"+s+":"+l+"Z":"")},toCurrency:function(e,t,i){e=Number(e),t===r&&(t=-1),i===r&&(i="$");var o="";0>e&&(o="-",e*=-1);var n=e;n=-1===t?n.toFixed(2).replace(".00",""):n.toFixed(t);for(var a=(Math.floor(e)+"").length,s=0,l=0,u=a%3;a>s;s++)0!=s&&s%3==u&&(n=n.substr(0,s+l)+","+n.substr(s+l),l++);return(""!=i?i:"")+o+n+(""!=i?"":" "+i)},getLookup:function(e){if(!e)return{id:"",value:""};var t=e.split(";#");return t.length<=2?{id:t[0],value:"undefined"==typeof t[1]?t[0]:t[1]}:{id:e.replace(/([0-9]+;#)([^;]+)/g,"$1").replace(/;#;#/g,",").slice(0,-2).split(","),value:e.replace(/([0-9]+;#)([^;]+)/g,"$2").split(";#")}},toXSLString:function(e){if("string"!=typeof e)throw"[SharepointPlus 'toXLSString'] '"+e+"' is not a string....";var t,r,i=function(e){var t,r,i,o,n,a,s,l=new Array("0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"),u="";for(t=0;t<e.length;t++){for(r=e.charAt(t),i=r.charCodeAt(0),o=0,n="";i>=16;)o=i%16,i=Math.floor(i/16),n+=l[o];for(n+=l[i],a="",s=n.length-1;s>=0;s--)a+=n.charAt(s);u+="%"+a}return u},o=e.split(" "),n="";for(/^[0-9]/.test(o[0])&&o[0].length<5&&(n=i(e.charAt(0)),e=e.substring(1)),t=0;t<e.length;t++)r=e.charAt(t),n+=/[0-9A-Za-z_]/.test(r)===!1?i(r).toLowerCase():r;return n.replace(/%([a-zA-Z0-9][a-zA-Z0-9])/g,"_x00$1_").substring(0,32)},formfields:function(e,t){return this.plugin("formfields",{fields:e,settings:t})},notify:function(e,t){var i=this;if(e===r)throw"[SharepointPlus notify'] you must provide the message to show.";if("string"!=typeof e)throw"[SharepointPlus notify'] you must provide a string for the message to show.";if(t=t||{},t.timeout=isNaN(t.timeout)?5:t.timeout,t.override=t.override===!0,t.overrideAll=t.overrideAll===!0,t.overrideSticky=t.overrideSticky!==!1,t.sticky=t.sticky===!0,t.name=t.name||(new Date).getTime(),t.after=t.after||function(){},t.fake=t.fake===!0,t.ignoreQueue=t.ignoreQueue===!0,_SP_NOTIFY_READY===!1)return _SP_NOTIFY_QUEUE.push({message:e,options:t}),ExecuteOrDelayUntilScriptLoaded(function(){ExecuteOrDelayUntilScriptLoaded(function(){_SP_NOTIFY_READY=!0,i.notify("fake",{fake:!0})},"core.js")},"sp.js"),i;if(t.ignoreQueue!==!0)for(;_SP_NOTIFY_QUEUE.length>0;){var o=_SP_NOTIFY_QUEUE.shift();o.options.ignoreQueue=!0,i.notify(o.message,o.options)}return t.fake!==!0?(_SP_NOTIFY.length>0&&(t.overrideAll?i.removeNotify({all:!0,includeSticky:t.overrideSticky}):t.override&&i.removeNotify(_SP_NOTIFY[_SP_NOTIFY.length-1].name)),_SP_NOTIFY.push({name:t.name,id:SP.UI.Notify.addNotification(e,!0),options:t}),t.sticky||setTimeout(function(){i.removeNotify(t.name,{timeout:!0})},1e3*t.timeout),i):void 0},removeNotify:function(e,t){var i=this;switch(arguments.length){case 0:throw"Error 'removeNotify': you must provide 'name' or 'options'.";case 2:if("object"!=typeof t)throw"Error 'removeNotify': you must provide an object for 'options'."}if(1===arguments.length&&"object"==typeof e&&(t=e,e=r),t=t||{all:!1},t.timeout=t.timeout===!0,_SP_NOTIFY_READY===!1&&_SP_NOTIFY_QUEUE.length>0)return setTimeout(function(){i.removeNotify(e,t)},150),i;var o;if(t.all===!0){for(var n=[];_SP_NOTIFY.length>0;)o=_SP_NOTIFY.shift(),t.includeSticky===!1&&o.options.sticky===!0?n.push(o):(SP.UI.Notify.removeNotification(o.id),setTimeout(function(){o.options.after.call(i,o.name,!1)},150));_SP_NOTIFY=n.slice(0)}else if(e!==r)for(var a=0,s=_SP_NOTIFY.length;s>a;a++)if(_SP_NOTIFY[a].name==e)return o=_SP_NOTIFY.splice(a,1)[0],SP.UI.Notify.removeNotification(o.id),setTimeout(function(){o.options.after.call(i,o.name,t.timeout)},150),i;return i},getPageSize:function(r){var i={width:0,height:0},o={width:0,height:0},n=r||e,a=n.document,s=a.documentElement,l=a.querySelector("body");return i.width=n.innerWidth||s.clientWidth||l.clientWidth,i.height=n.innerHeight||s.clientHeight||l.clientHeight,o.width=Math.max(l.scrollWidth,s.scrollWidth,l.offsetWidth,s.offsetWidth,l.clientWidth,s.clientWidth),o.height=Math.max(l.scrollHeight,s.scrollHeight,l.offsetHeight,s.offsetHeight,l.clientHeight,s.clientHeight),t.all&&t.querySelector&&!t.addEventListener&&i.width+4==o.width&&i.height+4==o.height&&(i.width=o.width,i.height=o.height),{vw:i,doc:o}},showModalDialog:function(r){function i(t,r){function i(){l||(l=!0,clearTimeout(s),r.call(this))}function o(){"complete"===this.readyState&&i.call(this)}function n(t,r,i){return t.addEventListener?t.addEventListener(r,i):t.attachEvent("on"+r,function(){return i.call(t,e.event)})}function a(){var e=t.contentDocument||t.contentWindow.document;0!==e.URL.indexOf("about:")?"complete"===e.readyState?i.call(e):(n(e,"DOMContentLoaded",i),n(e,"readystatechange",o)):s=setTimeout(a,1)}var s,l=!1;n(t,"load",function(){var e=t.contentDocument;e||(e=t.contentWindow,e&&(e=e.document)),e&&i.call(e)}),a()}var o=this;if(!_SP_MODALDIALOG_LOADED&&(_SP_MODALDIALOG_LOADED="object"==typeof SP&&"object"==typeof SP.UI&&"function"==typeof SP.UI.ModalDialog&&"function"==typeof SP.UI.ModalDialog.showModalDialog,!_SP_MODALDIALOG_LOADED))return LoadSodByKey("sp.ui.dialog.js",function(){_SP_MODALDIALOG_LOADED=!0,o.showModalDialog(r)}),o;var n,a;r.id=(r.id||"").replace(/\W+/g,""),r.id=r.id||(new Date).getTime();var s="sp_frame_"+r.id;r.html&&"string"==typeof r.html&&(a=t.createElement("div"),a.style.padding="10px",a.style.display="inline-block",a.className="sp-showModalDialog",a.id="content_"+s,a.innerHTML=r.html,r.html=a),"calculated"!==r.width&&"calculated"!==r.height||(n=o.getPageSize(),"calculated"===r.width&&(r.width=n.vw.width,r.width>768&&(r.width=2*r.width/3)),"calculated"===r.height&&(r.height=n.vw.height,r.height>576&&(r.height=90*r.height/100))),"full"!==r.width&&"full"!==r.height||(n=o.getPageSize(),"full"===r.width&&(r.width=n.vw.width),"full"===r.height&&(r.height=n.vw.height)),r.wait=r.wait===!0,r.closePrevious=r.closePrevious===!0,r.previousClose===!0&&(r.closePrevious=!0),r.closePrevious&&o.closeModalDialog(),r.showClose===!1&&(r.dialogReturnValueCallback||r.callback)&&(r.showClose=!0,r.hideClose=!0);var l=r.dialogReturnValueCallback||r.callback||function(){};r.dialogReturnValueCallback=function(t,r){var i,o;if("object"==typeof t&&"undefined"!=typeof t.type&&"closeModalDialog"===t.type){var n=t;t=n.dialogResult,r=n.returnValue,i=n.id}if(i)for(var a=0;a<e.top._SP_MODALDIALOG.length;a++)if(e.top._SP_MODALDIALOG[a].id===i){o=e.top._SP_MODALDIALOG.splice(a,1),o=o[0];break}o||(o=e.top._SP_MODALDIALOG.pop()),e.top.document.body.removeChild(e.top.document.getElementById("style_"+o.id)),l.call(this,t,r)};var u=function(){var t=r.wait?SP.UI.ModalDialog.showWaitScreenWithNoClose(r.title,r.message,r.height,r.width):SP.UI.ModalDialog.showModalDialog(r),o=e.top,n=s,a=o.document.querySelectorAll("body > iframe"),l=a[a.length-1],u=0;if(l.setAttribute("id",n),"undefined"==typeof o._SP_MODALDIALOG&&(o._SP_MODALDIALOG=[]),o._SP_MODALDIALOG.push({id:n,modal:t,zIndex:l.style.zIndex,options:r,type:"modalDialog"}),o._SP_MODALDIALOG.forEach(function(e){e.zIndex>u&&(u=e.zIndex)}),u--,o.document.body.insertAdjacentHTML("beforeend",'<style id="style_'+n+'">.ms-dlgOverlay { z-index:'+u+" !important; display:block !important }</style>"),r.hideClose===!0){var c=l.nextSibling.querySelector(".ms-dlgCloseBtn");c.parentNode.removeChild(c)}if("function"==typeof r.onload&&r.onload(),r.url&&r.onurlload&&"function"==typeof r.onurlload){var d=o.document.getElementById(n);d&&(d=d.nextSibling),d&&(d=d.querySelector("iframe")),d&&i(d,r.onurlload)}};SP.SOD.executeOrDelayUntilScriptLoaded(u,"sp.ui.dialog.js")},closeModalDialog:function(t,i){var o=function(){var o;if("object"==typeof t&&"undefined"!=typeof t.type&&"modalDialog"===t.type)o={id:t.id,dialogResult:i,returnValue:r,type:"closeModalDialog"},t.modal.close(o),t.options.wait&&t.options.dialogReturnValueCallback(o,i);else{if("undefined"!=typeof e.top._SP_MODALDIALOG&&(o=e.top._SP_MODALDIALOG,o.length>0))return o=o[o.length-1],o.modal.close({id:o.id,dialogResult:t,returnValue:i,type:"closeModalDialog"}),o.options.wait&&o.options.dialogReturnValueCallback(t,i),!1;SP.UI.ModalDialog.commonModalDialogClose(t,i)}};return SP.SOD.executeOrDelayUntilScriptLoaded(o,"sp.ui.dialog.js"),!1},getModalDialog:function(t){if("undefined"!=typeof e.top._SP_MODALDIALOG){var r=e.top._SP_MODALDIALOG;t=t.replace(/\W+/g,"");for(var i=0;i<r.length;i++)if(r[i].id==="sp_frame_"+t)return r[i]}return null},waitModalDialog:function(e,t,r,i){return this.showModalDialog({wait:!0,title:e||"Working...",message:t,width:i,height:r})},resizeModalDialog:function(t){var i,o,n,a,s,l=function(e){return 1*e.replace(/px/,"")},u=e.top;if(!t.id){if(0===u._SP_MODALDIALOG.length)return!1;t.id=u._SP_MODALDIALOG[u._SP_MODALDIALOG.length-1].id.replace(/sp_frame_/,"")}if(i=u.document.getElementById("sp_frame_"+t.id),!i)return!1;i=i.nextSibling,t.width=t.width===r?l(i.style.width):t.width,t.height=t.height===r?l(i.style.height):t.height,o={Border:i.querySelector(".ms-dlgBorder"),TitleText:i.querySelector(".ms-dlgTitleText"),Content:i,Frame:i.querySelector(".ms-dlgFrame")},n=t.width-l(o.Border.style.width),a=t.height-l(o.Border.style.height);for(s in o)o.hasOwnProperty(s)&&o[s]&&(o[s].style.width=l(o[s].style.width)+n+"px","TitleText"!==s&&(o[s].style.height=l(o[s].style.height)+a+"px"));var c=this.getPageSize(u);i.style.top=c.vw.height/2-l(i.style.height)/2+"px",i.style.left=c.vw.width/2-l(i.style.width)/2+"px"},registerPlugin:function(e,t){if("undefined"!=typeof _SP_PLUGINS[e])throw"[SharepointPlus 'registerPlugin'] '"+e+"' is already registered.";return _SP_PLUGINS[e]=t,!0},plugin:function(e,t){if(t=t||{},"function"==typeof _SP_PLUGINS[e])return _SP_PLUGINS[e].call(this,t);throw"[SharepointPlus 'plugin']: the plugin '"+e+"' is not registered."}};var n=function(){var e=function(e){return new t(e)},t=function(e){return this.mynode=e,this.singleList=!0,this};return e.fn=t.prototype={getAttribute:function(e){return this.mynode.getAttribute("ows_"+e.replace(/ /g,""))},getAttributes:function(){return this.mynode.attributes}},e}(),a=function(e){this.attributes=e};return a.prototype.getAttribute=function(e){return this.attributes[e]},a.prototype.getAttributes=function(){return this.attributes},i.prototype.noConflict=function(){e._$SP=e._SharepointPlus=e.$SP},_SP_ISBROWSER||"undefined"==typeof exports?e.$SP=e.SharepointPlus=i:("undefined"!=typeof module&&module.exports&&(exports=module.exports=i),exports.SharepointPlus=i),i}(this,"undefined"!=typeof document?document:null);
